<!DOCTYPE html>
<html>
  
  <head>
    <!--Disables zoom, may need a workaround if it reduces accessibility: https://stackoverflow.com/questions/4472891/how-can-i-disable-zoom-on-a-mobile-web-page-->
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="viewport-fit=cover, shrink-to-fit=no, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <meta name="viewport" content="viewport-fit=cover">  -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, maximum-scale=1, viewport-fit=cover">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js" integrity="sha256-hlKLmzaRlE8SCJC1Kw8zoUbU8BxA+8kR3gseuKfMjxA=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>Santa Barbara High School</title>
  </head>
  <body>

    <div id="overlay">
      <div id="space-tooltip"></div>
      <img id="success-icon">
      <div id="space-settings-popup">
        <div class="pointer blue-entry-two" id="create-section-button">Create Section</div>
        <div class="pointer blue-entry-two" id="edit-space-button">Edit Space</div>
        <div class="pointer blue-entry-two" id="invite-link-button">Copy Invite</div>
        <div class="pointer red-space-button" id="leave-space">Leave Space</div>
        <div class="pointer red-space-button" id="delete-space">Delete Space</div>
      </div>
    </div>

    <!--Space Directory Page-->
  	<div id="space-search">
  	  <!-- <div id="user-directory">
  	    <h1>User Directory</h1>
  	  </div> -->

      <div id="space-directory-lfg-header">
        <span id="space-directory-lfg-title">Club Directory</span>
        <div id="directory-search">
          <textarea id="directory-search-bar" placeholder="Search..."></textarea>
          <img src="/static/images/temporary-search.png" id="directory-search-button" class="pointer">
        </div>
        <!--UI For Double Click (Back and Home Button Overlayed)-->
        <img class="pointer white-icon" id="close-space-search-button" src="/static/images/x.svg">
      </div>

        <!--TODO: implement Table Layout Later-->
        <!-- <div class = empty side columns> <table id="directory-space">
          <tr>
            <th>(Banner)</th>
            <th>Moderator</th>
            <th>Name / Description</th>
            <th>Meta</th>
          </tr>
        <table> -->
      <div id="directory-space">
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
        <div class="form-space-filler"></div>
      </div>
    </div>

    <!--Home Page-->
    <div id="home-page">
      <img id="logo" src="/static/images/sbhs.png">
      <div class="main-header">
        <!-- <p>One Connected Application</p> -->
        <img class="white-icon pointer" id="server-settings-button" src="/static/images/settings.svg">
      </div>
      <div class="feed"><p>This webapp was made possible by students of the Computer Science Academy. Follow us on Instagram @oneconnected.app</p></div>
      <!--<div id="special-announcements" class="home-grid"></div>
      <div id="feed" class="home-grid"></div>
      <div id="direct-messaging" class="home-grid"></div>-->
    </div>

    <div id="administrator-page">
      <div class="main-header">
        <div id="admin-settings" class="admin-tab pointer">Settings</div>
        <div id="admin-logs" class="admin-tab pointer">Logs</div>
        <div id="admin-users" class="admin-tab pointer">Users</div>
        <div id="admin-pending" class="admin-tab pointer">Pending Spaces</div>
        <img class="pointer white-icon" id="exit-server-settings" src="/static/images/x.svg">
      </div>
      <div id='admin-search'>
        <textarea id="admin-search-bar" placeholder="Search..."></textarea>
        <img src="/static/images/temporary-search.png" id="admin-search-button" class="pointer">
      </div>
      <div id="admin-filters">
        <form class="no-drag">
          <input type="checkbox" class="admin-log-filters" id="deleted-message-filter" name="deleted-message-filter" checked>
          <label for="deleted-message-filter">Deleted messages</label>
          <input type="checkbox" class="admin-log-filters" id="reported-message-filter" name="reported-message-filter" checked>
          <label for="reported-message-filter">Reported messages</label>
          <input type="checkbox" class="admin-log-filters" id="edited-message-filter" name="edited-message-filter" checked>
          <label for="edited-message-filter">Edited messages (before change)</label>
          <input type="checkbox" class="admin-log-filters" id="expand-message-filter" name="expand-message-filter">
          <label for="expand-message-filter">Expand all</label>
        </form>
      </div>
      <div id="admin-table-wrapper">
        <table class="admin-table" id="admin-settings-table">
          <thead>
            <tr>
              <td></td>
            </tr>
          </thead>
          <tbody id="admin-settings-body">
          </tbody>
        </table>
        <table class="admin-table" id="admin-logs-table">
          <thead>
            <tr>
              <th width="19%">User</th>
              <th width="19%">Action</th>
              <th width="19%">By</th>
              <th width="19%">Space</th>
              <th width="19%">Datetime</th>
              <th width="5%">Details</th>
            </tr>
          </thead>
          <tbody id="admin-logs-body">
          </tbody>
        </table>
        <table class="admin-table" id="admin-users-table">
          <thead>
            <tr>
              <th width="35%">User</th>
              <th width="35%">Email</th>
              <th width="30%">Status</th>
            </tr>
          </thead>
          <tbody id="admin-users-body">
          </tbody>
        </table>
        <table class="admin-table" id="admin-pending-table">
          <thead>
            <tr>
              <th width="20%">User</th>
              <th width="20%">Email</th>
              <th width="20%">Space Name</th>
              <th width="20%">Space Description</th>
              <th width="15%">Approved?</th>
            </tr>
          </thead>
          <tbody id="admin-pending-body">
          </tbody>
        </table>
      </div>
    </div>

    <!--Spaces Page-->
    <div id="first-all">
      <div id="mobile_touch_overlay" class="pointer"></div>
      <div id="content">
        <div id="header">
          <span id="header_text"></span>
          <div id="space-settings-button-container">
            <img class="white-icon pointer" id="space-settings-button" src="/static/images/settings.svg">
          </div>
        </div>
        <div id="information">
          <span id="left-info">
            <img class="pointer" id="open_channels" src="/static/images/hamburger.png">
            <span id="room-name-display"></span>
          </span>
          <span id="right-info">
            <img class="pointer home" id="home_button" src="/static/images/home-white.png">
            <img class="pointer" id="open_members" src="/static/images/person.png">
          </span>
        </div>
        <div id="channels">
          <ul id="special-channels"></ul>
          <ul id="regular-channels"></ul>
        </div>

<!--         when new message is sent, make the new message appear above the message bar and not mess up the scrolling (Safari only). -->
        <div id="chats">
          <div id="chat">
            <div id="messages">
            </div>
          </div>
          <!--Recipients, Message, Date, Theme,
           Name of bmiter (email), Name of the space*/-->
          <form id="email_input_form">
            <div id="email_to_wrapper">
              <div id="email_to">
                <div id="email_to_list">
                  <span><label id="email_to_label" for="email_to_input">To: </label></span>
                  <span id="email_to_input_span"><input id="email_to_input" type="text" placeholder="" maxlength="254"></input></span>
                </div>
              </div>
              <div id="suggested_emails">
                <div class="suggested_email suggested_email_everyone pointer">Everyone</div>
              </div>
            </div>
            <!-- <label id="email_cc_label">To:</label>
            <textarea id="email_cc_input" rows="1" placeholder="Who are you sending it to?"></textarea>
            <label id="email_bcc_label">To:</label>
            <textarea id="email_bcc_input" rows="1" placeholder="Who are you sending it to?"></textarea> -->
            <input id="email_subject_input" type="text" placeholder="Subject" maxlength="70" required></input>
            <textarea id="email_message_input" maxlength="10000" rows="1" required></textarea>
            <div id="email_options">
              <div id="submit_email" class="pointer">Send</div>
            </div>
          </form>
          <form id="message_input_form">
            <!--see w3schools input attributes like max char, spam, etc. -->
            <textarea id="message_input" rows="1" placeholder="Enter message" maxlength="2000"></textarea>
<!--             <input type="text" id="message_input" placeholder="Enter message"> -->
            <button type="submit" id="submit"><img class="send" src="/static/images/send.png" alt="Send"></button>
          </form>
          <span id="typing_display"></span>
        </div>
        <div id="members">
        </div>
        <div id="members_header"></div>
        <!-- can get rid of once mobile app created -->
        <div id="channels_bottom"></div>
        <div id="chats_bottom"></div>
        <div id="members_bottom"></div>
      </div>
    </div>

    <div id="footer">
      <div id="profile">
        <!-- load exclamation mark icon if not showing -->
        <img src={{ user_picture }} alt="pfp" class="profile-picture pointer">
        <div id="profile-info-wrapper">
          <p id="username" class="pointer">{{ user_name }}</p>
          <p id="student_id" class="pointer">Santa Barbara High School</p>
        </div>
        <div id="settings-container">
          <img class="white-icon pointer" id="settings" src="/static/images/settings.svg">
        </div>
      </div>
      <img class="pointer home" id="home_button_mobile" src="/static/images/home-white.png">
      <ul id="spaces">
        <span id="space_align_helper"></span>
        <button type="button" id="create-space-button"><img src="/static/images/ppicons-plus.svg" alt="create" style="width:25px;height:25px;"></button>
        <button type="button" id="space-search-button"><img src="/static/images/temporary-search.png" alt="create" style="width:25px;height:25px;"></button>
      </ul>
     </div>

    <!--Space Settings Page-->
    <div class="settings-pages" id="space-settings">
      <div class="space-settings-select">
        <div class="space-settings-column">
          <div class="space-settings-selection pointer" id="space-settings-general" style="background-color: var(--selected-color) !important">Space Settings</div> 
          <div class="space-settings-selection pointer" id="space-settings-themes">Themes</div> 
          <div class="space-settings-selection pointer" id="space-settings-members">Manage Users</div> 
        </div>
      </div>

      <div class="space-settings-expand">
        <div id="space-settings-general-selection">
          <form id="edit-space-profile">
            <label for="space-name" class="space-settings-header">Space Name</label><br>
            <input type="text" id="edit-space-name-input"><br>
            <label for="space-picture">Space Picture</label><br>
            <input type="text" id="edit-space-picture-input"><br>
            <label for="space-picture">Space Description</label><br>
            <input type="text" id="edit-space-description-input"><br>
            <label for="invite-only" class="space-settings-header">Invite Only</label><br>
            <label class="switch">
              <input type="checkbox" id='edit-space-invite-switch'>
              <span class="slider round"></span>
            </label>
            <input type="submit" style="display: none;">
          </form>
        </div>
        <div id="space-settings-themes-selection">
          <p class="space-settings-header">Basic Themes</p>
          <div id="theme-selection">
            <div class="theme-container pointer" id="default-theme">
              <div class="theme-preview" id="default-preview"></div>
              <div class="theme-name">Default</div>
            </div>
            <div class="theme-container pointer" id="dark-theme">
              <div class="theme-preview" id="dark-preview"></div>
              <div class="theme-name">Dark</div>
            </div>
            <div class="theme-container pointer" id="nature-theme">
              <div class="theme-preview" id="nature-preview"></div>
              <div class="theme-name">Nature</div>
            </div>
          </div>
        </div>
        <div id="space-settings-members-selection">
          <p class="space-settings-header">Members</p>
          <div id="space-members-list">
            <div class="space-members-list-item">
              <img><span class="member-information">Name (Email)</span><span class="user-role">Banned/User/Admin</span>
            </div>
          </div>

          <p class="space-settings-header">Invites</p>
          <div id="space-invites-list">
            <div class="space-invites-list-item">
              <img><span class="invite-information">Name (Email) created invite</span><span class="invite-code">Invite Link</span><span class="revoke-link">Revoke</span>
            </div> 
          </div>
        </div>
        <img class="pointer white-icon close-settings-page" id="close-space-settings-button" src="/static/images/x.svg">
      </div>
    </div>

    <!--User Settings Page-->
    <div class="settings-pages" id="user-page">
      <div class="space-settings-select">
        <div class="space-settings-column">
          <div class="space-settings-selection pointer" id="personal-settings-general" style="background-color: var(--selected-color) !important">Preferences</div> 
          <div class="space-settings-selection pointer" id="log-out">Log Out</div> 
        </div>
      </div>
      <div class="space-settings-expand">
        <div id="user-settings-general-selection">Nothing to see here, yet!
        </div>
        <img class="pointer white-icon close-settings-page" id="close-user-page" src="/static/images/x.svg">
      </div>
    </div>

    <div id="create-space" class="modal">
      <div class="modal-content">
        <span id="close-create-space" class="close">&times;</span>
        <form id="create-space-form">
          <label for="space-name">Space Name (will be verified by school official):</label><br>
          <input type="text" id="space-name" maxlength="200"><br>
          <!--Accept Files, Sanitize Files, Compress Files-->
          <label for="space-picture">Space Picture (currently only accepts links):</label><br>
          <input type="text" id="space-picture"  maxlength="2000"><br>
          <label for="space-description">Space Description:</label><br>
          <input type="text" id="space-description" maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="create-room" class="modal">
      <div class="modal-content">
        <span id="close-create-room" class="close">&times;</span>
        <form id="create-room-form">
          <label for="room-name">Room Name:</label><br>
          <input type="text" id="room-name"  maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="create-section" class="modal">
      <div class="modal-content">
        <span id="close-create-section" class="close">&times;</span>
        <form id="create-section-form">
          <label for="section-name">Section Name:</label><br>
          <input type="text" id="section-name"  maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <!--New Modals Here-->
    <div id="confirm-delete-space" class="modal">  <!--Backend check for character limit and other security-->
      <div class="modal-content">
        <span id="close-confirm-delete-space" class="close">&times;</span>
        <form id="confirm-delete-space-form">
          <label for="confirm-space-name">Enter space name to confirm deletion:</label><br>
          <input type="text" id="confirm-space-name"  maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="confirm-leave-space" class="modal">
      <div class="modal-content">
        <span id="close-confirm-leave-space" class="close">&times;</span>
        <p class="modal-header">Are you sure you want to leave this space?</p>
        <div class="confirm-button" id="confirm-leave-space-button">Confirm</div>
      </div>
    </div>
    <div id="confirm-delete-section" class="modal">
      <div class="modal-content">
        <span id="close-confirm-delete-section" class="close">&times;</span>
        <p class="modal-header">Are you sure you want to delete this section?</p>
        <div class="confirm-button" id="confirm-delete-section-button">Confirm</div>
      </div>
    </div>
    <div id="confirm-delete-channel" class="modal">
      <div class="modal-content">
        <span id="close-confirm-delete-channel" class="close">&times;</span>
        <p class="modal-header">Are you sure you want to delete this channel?</p>
        <div class="confirm-button" id="confirm-delete-channel-button">Confirm</div>
      </div>
    </div>
    <div id="confirm-delete-message" class="modal"> 
      <div class="modal-content">
        <span id="close-confirm-delete-message" class="close">&times;</span>
        <p class="modal-header">Are you sure you want to delete this message?</p>
        <div class="confirm-button" id="confirm-delete-message-button">Confirm</div>
      </div>
    </div>
    <div id="confirm-report-message" class="modal"> <!--Backend check for character limit and other security-->
      <div class="modal-content">
        <span id="close-confirm-report-message" class="close">&times;</span>
        <form id="confirm-report-message-form">
          <label for="confirm-report-message">Why are you reporting this message?</label><br>
          <textarea id="report-message-note" rows="1" placeholder="Reason" maxlength="800"></textarea>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="edit-channel-modal" class="modal"> <!--Backend check for character limit and other security-->
      <div class="modal-content">
        <span id="close-edit-channel" class="close">&times;</span>
        <form id="edit-channel-form">
          <label for="new-channel-name">Channel Name:</label><br>
          <input type="text" id="new-channel-name"  maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="edit-section-modal" class="modal"> <!--Backend check for character limit and other security-->
      <div class="modal-content">
        <span id="close-edit-section" class="close">&times;</span>
        <form id="edit-section-form">
          <label for="new-section-name">Section Name:</label><br>
          <input type="text" id="new-section-name"  maxlength="200"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>


    <ul id="section-menu" class="context-menu">
      <li id="edit-section" class="blue-entry pointer">Edit Section</li> 
      <li id="delete-section" class="red-entry pointer">Delete Section</li>
    </ul>

    <ul id="room-menu" class="context-menu">
      <li id="edit-room" class="blue-entry pointer">Edit Channel</li> 
      <li id="delete-room" class="red-entry pointer">Delete Channel</li>
    </ul>
    
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
  
  <script type="text/javascript" charset="utf-8">
    //Give small space to empty categories room-group 
    $(document).ready(function() {
      
      var socket = io();
      var chat_history_skip = 0;
      var last_loaded = '';
      var current_room = '';
      var typing = false;
      var timeout = null;
      var current_space = '';
      var typing_list = [];
      var selected_section = '';
      var selected_room = '';
      var selected_message = '';
      var space_admin = false;
      var admin = false;
      var user_id = '{{ user_id }}';
      var user_picture = '{{ user_picture }}';
      var user_name = '{{ user_name }}';
      var selected_user = '';
      var add_to_members = false;
      var mobile_column = 1;
      var mobile = ($(window).width() <= 768);
      var requests = [];

      var themes = {'default': ['#2f3136', 'white', '#36393e', '#d7d9da', 'hotpink', '#282a2e', '#232428', 'white', '#202225', '#2e3338', '35, 36, 40', 'white', 'black', '#3c3f45', '#32353a', '#43474d', 'brightness(0)'],
                    'dark': ['#111112', 'white', '#111112', '#d7d9da', '#111112', '#111112', '#232428', 'white', '#5e5e5e', '#333333', '35, 36, 40', 'white', 'black', '#3c3f45', '#222224', '#43474d', 'brightness(0) invert(1)'],
                    'nature': ['#1b4332', 'white','#2d6a4f','white','#e9c46a','#0a241b','black','white','#d8f3dc','#3d8262','16, 41, 30','white','black','#2d6a4f','#40916c','#40916c', 'brightness(0)']};

      // Check if it's Safari on anything besides desktop
      // var isSafari = navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
      //          navigator.userAgent &&
      //          navigator.userAgent.indexOf('CriOS') == -1 &&
      //          navigator.userAgent.indexOf('FxiOS') == -1;


      var isChromium = window.chrome;
      var winNav = window.navigator;
      var vendorName = winNav.vendor;
      var isOpera = typeof window.opr !== "undefined";
      var isIEedge = winNav.userAgent.indexOf("Edg") > -1;
      var isIOSChrome = winNav.userAgent.match("CriOS");

      var ua = window.navigator.userAgent;
      var webkit = !!ua.match(/WebKit/i);
      var iOSSafari = webkit && !ua.match(/CriOS/i) && !ua.match(/OPiOS/i) && !ua.match(/EdgiOS/i) && !ua.match(/FxiOS/);


      if (iOSSafari || isIOSChrome) {
        if(getComputedStyle(document.documentElement).getPropertyValue("--sab") == "0px") {
          $('#content').css('grid-template-rows', '48px calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px - 48px - var(--sab))');
          $('#mobile_touch_overlay').css('height', 'calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px + 50px - var(--sab))');
        }
        else {
          $('#content').css('grid-template-rows', '48px calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px - 48px)');
          $('#mobile_touch_overlay').css('height', 'calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px + 50px)');
        }
        // TODO: Whenever a user presses on a textarea, remove this eventlistener then add it back when they are done.
        window.addEventListener("scroll", (e) => {
          e.preventDefault();
          window.scrollTo(0, 0);
        });
      }
      
      // $('#content').css('grid-template-rows', '48px calc(100vh ' - getComputedStyle(document.documentElement).getPropertyValue("--sab") + 'px - 48px)');
      // $('#mobile_touch_overlay').css('height', 'calc(100vh ' - getComputedStyle(document.documentElement).getPropertyValue("--sab") + 'px + 50px)');
      
      $("#regular-channels").sortable({
        axis: 'y',
        opacity: 0.7,
        scroll: false,
        items: '.section-group',
        distance: '3',
        update: function() {
          let sections = document.querySelectorAll(".section");
          let section_list = [];
          for (let i = 0; i < sections.length; i++) {
            section_list.push(sections[i].id);
          }
          socket.emit('sorted_sections', {
            section_list: section_list
          });
        }
      });

      $('#spaces').sortable({
        axis: 'x',
        items: "> li",
        opacity: 0.7,
        scroll: false,
        distance: '3',
        update: function() {
          let spaces = document.querySelectorAll('.space');
          let space_list = [];
          for (let i = 0; i < spaces.length; i++) {
            space_list.push(spaces[i].id);
          }
          $.ajax({
            type: 'POST',
            url: '/sorted_spaces',
            data: JSON.stringify({'space_list': space_list.reverse()}),
            contentType: 'application/json;charset=UTF-8'
          });
        }
      });

      $.ajax({
        type: 'POST',
        url: '/list_spaces',
        dataType: "json",
        success: function(data) {
          if (data[2] == 'True') {
            admin = true;
            document.getElementById('server-settings-button').style.display = 'inline-block';
          }
          data[1].forEach(function(item) { 
            try {
              let newNode = document.createElement('li'); 
              newNode.className = 'space-wrapper';
              let newNodeChild = document.createElement('img');
              newNodeChild.className = 'space pointer';
              newNodeChild.id = item._id.$oid;
              newNodeChild.setAttribute('data-name', item.name);
              newNodeChild.src = item.picture;
              newNode.appendChild(newNodeChild);
              newNodeChild = document.createElement('div');
              newNodeChild.className = 'active-space';
              newNode.appendChild(newNodeChild); 
              referenceNode = document.getElementById('space_align_helper'); 
              referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling); 
            }
            catch(e) {
            }
          });
          data[0].forEach(function(item) {
            newNode = document.createElement('div');
            newNode.className = 'form-space pointer';
            newNode.setAttribute('data-id', item['_id']['$oid']);
            newNodeChild = document.createElement('img');
            newNodeChild.className = 'directory-space-img';
            newNodeChild.src = item['picture'];
            newNode.appendChild(newNodeChild);
            newNodeChild = document.createElement('div');
            newNodeChild.className = 'directory-space-title';
            newNodeChild.textContent = item['name'];
            newNode.appendChild(newNodeChild);
            newNodeChild = document.createElement('div');
            newNodeChild.className = 'directory-space-description';
            newNodeChild.textContent = item['description'];
            newNode.appendChild(newNodeChild);

            let newNodeWrapper = document.createElement("div");
            newNodeWrapper.className = "member-joined-status-wrapper";
            newNode.appendChild(newNodeWrapper);


            newNodeChild = document.createElement('span');
            newNodeChild.innerHTML = '<img class="green-icon joined-members-icon" src="/static/images/members.svg">';
            newNodeChild.className = 'directory-space-members';
            newNodeChild.appendChild(document.createTextNode(item['members'].length));
            newNodeWrapper.appendChild(newNodeChild);
            newNodeChild = document.createElement('span');
            if (item['invite_only'] == true) { // Have invite only/open instead
              newNodeChild.textContent = 'Invite Only';
              newNodeChild.className = 'directory-space-joined-status invite-status';
              newNodeChild.setAttribute('data-original', 'Invite Only');
            }
            else {
              newNodeChild.textContent = 'Open';
              newNodeChild.className = 'directory-space-joined-status open-status';
              newNodeChild.setAttribute('data-original', 'Open');
            }
            if (item['members'].some(row => row.includes(user_id))){
              newNodeChild.textContent = 'Joined';
              newNodeChild.className = 'directory-space-joined-status joined-status';
            }
            newNodeWrapper.appendChild(newNodeChild);
            document.getElementById('directory-space').prepend(newNode);
          });
          if (window.location.href.indexOf('/school/') != -1) {
            joinSpace(window.location.href.substring(window.location.href.indexOf('/school/') + 8).replace('#',''));//number 8 is for the character count of "/school/"
          }
        }
      });

      $(document).on("mouseover", '.space', function () {
        var location = this.getBoundingClientRect();
        $('#space-tooltip').text(this.getAttribute('data-name'));
        $('#space-tooltip').css({'left': location.left + 22 - $('#space-tooltip').width() / 2, 'bottom': 55 + parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sab").slice(0, -2)), 'visibility': 'visible'})
        $("#space-tooltip").animate({opacity: '1'}, 150);
      });

      $(document).on("mouseleave", '.space', function () {
        $("#space-tooltip").css({'opacity': '0', 'visibility': 'hidden'});
      });

      $(document).on('click', function(e) {
        //// If you input: "&& profile_popup.has(e.target).length === 0)"" it makes it so clicking on a child will not remove it
        // hide contextmenu on popup and viceversa
        let container = $("#space-settings-popup");
        let profile_popup = $("#profile-popup");
        let section_menu = $('#section-menu');
        let room_menu = $('#room-menu');
        // For container and context_menu, check if it exists as well.
        if (!room_menu.is(e.target)) 
        {
          room_menu.hide();
        }
        if (!section_menu.is(e.target)) 
        {
          section_menu.hide();
        }
        if (!container.is(e.target) && !$('#space-settings-button').is(e.target)) 
        {
          container.hide();
          // TODO: Make this function function only when popups appear (use .off function?)
          // https://stackoverflow.com/questions/67973984/getting-desired-event-target-when-listener-is-on-the-document
        }
        //alert(!$('.member').is(e.target));
        if (!!document.getElementById("profile-popup") && !e.target.closest('#profile-popup')) {
          profile_popup.remove();
          selected_user = '';
          $('.member').css('background-color', '');
          $('.member').addClass('pointer');
        }
        if (!!document.getElementById("suggested_emails") && !e.target.closest('#suggested_emails') && !e.target.closest('#email_to_input')) {
          document.getElementById("suggested_emails").style.display = 'none';
        }
        /*if (!!document.getElementById("profile-popup") && (!$('.member').is(e.target) && !$('.member').is(e.target.parentNode) || (!profile_popup.is(e.target) && profile_popup.contains(e.target)))) { 
          profile_popup.remove();
          selected_user = '';
          $('.member').css('background-color', '');
          $('.member').addClass('pointer');
          // Removes Profile Popups, Probably Optimize and Combine This With Above
        }*/
      });

      $(document).on('click', '#log-out', function () {
        $.ajax({
          type: 'POST',
          url: '/logout',
          dataType: "json",
          success: function(data) {
            window.location.href = "https://www.oneconnected.app";
          }
        });
      });

      $(document).on('click', '.home', function() {
        window.history.pushState('', '', '/school');
        $('#' + current_space).attr('style', '');
        current_space = '';
        current_room = '';
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'block');
        $('#first-all').css('display', 'none');
        $('#administrator-page').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#space-search').css('display', 'none');
      });

      $(document).on('click', '#server-settings-button, #admin-logs', function() {
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'none');
        $('#first-all').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#administrator-page').css('display', 'block');
        $('#admin-logs-table').css('display', 'table');
        $('#admin-users-table').css('display', 'none');
        $('#admin-pending-table').css('display', 'none');
        $('#admin-settings-table').css('display', 'none');
        $('#admin-filters').css('display', 'block');
        $('#admin-logs-body').empty();
        $('#admin-users-body').empty();
        $('#admin-settings-body').empty();
        $('#admin-pending-body').empty();
        $('#admin-search-bar').val('');
        $('.admin-tab').removeClass('admin-tab-selected');
        $('#admin-logs').addClass('admin-tab-selected');
        chat_history_skip = 0;
        last_loaded = '';
        loadLogHistory();
      });

      function loadLogHistory() {
        const options = [document.getElementById("admin-search-bar").value, document.getElementById('reported-message-filter').checked, document.getElementById('deleted-message-filter').checked, document.getElementById('edited-message-filter').checked];
        abortRequests();
        requests.push($.ajax({
          type: "POST",
          url: '/server_logs',
          dataType: "json",
          data: JSON.stringify({'i': String(chat_history_skip), 'options': options}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            if (data.length != 0) {
              const skip = data.map(function(e) { return e._id.$oid; }).indexOf(last_loaded);
              if (skip != -1) {
                chat_history_skip += skip + 1;
                data.splice(0, skip + 1);
              }
              chat_history_skip += 50;
              const newFragment = document.createDocumentFragment();
              data.forEach(function (item) {
                let newNode = document.createElement('tr');
                newNode.innerHTML = '<td style="white-space: pre;"></td><td></td><td style="white-space: pre;"></td><td><div class="admin-logs-space-link"></div></td><td></td><td><img class="expand-log" src="/static/images/expand.png"></td>'
                newNode.className = 'admin-logs-table-row pointer';
                newNode.firstElementChild.textContent = item.name + '\r\n' + item.email;
                newNode.firstElementChild.nextElementSibling.textContent = item.action;
                newNode.firstElementChild.nextElementSibling.nextElementSibling.textContent = item.by + '\r\n' + item.by_email;
                newNode.querySelector('.admin-logs-space-link').textContent = item.in;
                newNode.querySelector('.admin-logs-space-link').setAttribute('data-id', item.space_id);
                newNode.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.textContent = moment(item.datetime).format('MMM Do YYYY, h:mm[]a');
                newFragment.appendChild(newNode);
                newNode = document.createElement('tr');
                newNode.innerHTML = '<td colspan="6" width="100%"><div class="message-container-logs"><img class="profile-picture pointer"><p class="message-title"><span style="font-weight: bold;"></span><span class="datetime"></span></p><p class="message-content-logs"></p></div></td>';
                newNode.className = 'admin-logs-table-row-details';
                newNode.style.backgroundColor = 'var(--second-hover-color)';
                newNode.firstElementChild.firstElementChild.firstElementChild.src = item.details.picture;
                newNode.querySelector('.message-title').firstElementChild.textContent = item.details.name;
                newNode.querySelector('.datetime').textContent = ' on ' + moment(item.details.datetime).local().format('MMM Do YYYY, h:mm[]a');
                if (item.action == 'reported message') {
                  newNode.querySelector('.message-content-logs').innerHTML = parseMarkdown(escapeHTML(item.details.message + '\n\n**USER REPORT NOTE:** ' + item.note))
                }
                else {
                  newNode.querySelector('.message-content-logs').innerHTML = parseMarkdown(escapeHTML(item.details.message));
                }
                newFragment.appendChild(newNode);
              });
              document.getElementById('admin-logs-body').appendChild(newFragment);
              if (!document.getElementById('expand-message-filter').checked) {
                $('.admin-logs-table-row-details').hide();
              }
              else {
                $('.expand-log').css({transform: 'rotate(0deg)'});
              }
              last_loaded = data[data.length - 1]._id.$oid;
              loadLogTrigger = true;
            }
          }
        }));
      }

      $(document).on('click', '.admin-logs-space-link', function() {
        joinSpace(this.getAttribute('data-id'));
      });

      $(document).on('click', '#admin-users', function() {
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'none');
        $('#first-all').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#administrator-page').css('display', 'block');
        $('#admin-logs-table').css('display', 'none');
        $('#admin-users-table').css('display', 'table');
        $('#admin-pending-table').css('display', 'none');
        $('#admin-settings-table').css('display', 'none');
        $('#admin-filters').css('display', 'none');
        $('#admin-logs-body').empty();
        $('#admin-users-body').empty();
        $('#admin-settings-body').empty();
        $('#admin-pending-body').empty();
        $('#admin-search-bar').val('');
        $('.admin-tab').removeClass('admin-tab-selected');
        $(this).addClass('admin-tab-selected');

        abortRequests();
        requests.push($.ajax({
          type: "POST",
          url: '/server_users',
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            const newFragment = document.createDocumentFragment();
            data.forEach(function (item) {
              let formNode = '';
              if (item.status == 'user') {
                formNode = '<form class="admin-change-user-status-form"><select class="user-status-select"><option value="banned">banned</option><option selected="selected" value="user">user</option><option value="admin">admin</option></select></form>';
              } 
              else if (item.status == 'admin') {
                formNode = '<form class="admin-change-user-status-form"><select class="user-status-select"><option value="user">user</option><option selected="selected" value="admin">admin</option></select></form>';
              }
              else if (item.status == 'banned') {
                formNode = '<form class="admin-change-user-status-form"><select class="user-status-select"><option selected="selected" value="banned">banned</option><option value="user">user</option><option value="admin">admin</option></select></form>';
              }
              else {
                formNode = '<select class="user-status-select" disabled><option value="owner">owner</option></select>';
              }
              let newNode = document.createElement('tr');
              newNode.className = 'admin-users-table-row';
              newNode.setAttribute('data-id', item._id);
              let newNodeChild = document.createElement('td');
              let newNodeChildChild = document.createElement('img');
              newNodeChildChild.className = 'profile-picture';
              newNodeChildChild.src = item.picture;
              newNodeChild.appendChild(newNodeChildChild);
              newNodeChild.appendChild(document.createTextNode(' ' + item.name))
              newNode.appendChild(newNodeChild);
              newNodeChild = document.createElement('td');
              newNodeChild.textContent = item.email;
              newNode.appendChild(newNodeChild);
              newNodeChild = document.createElement('td');
              newNodeChild.innerHTML = formNode;
              newNode.appendChild(newNodeChild);
              newFragment.appendChild(newNode);
              //newNode.innerHTML = '<td><img class="profile-picture" src="' + item.picture + '"> ' + item.name + '</td><td>' + item.email + '</td><td>' + formNode + '</td>';
            });
            document.getElementById('admin-users-body').appendChild(newFragment);
          }
        }));
      });
      $(document).on('click', '#admin-pending', function() {
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'none');
        $('#first-all').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#administrator-page').css('display', 'block');
        $('#admin-logs-table').css('display', 'none');
        $('#admin-users-table').css('display', 'none');
        $('#admin-pending-table').css('display', 'table');
        $('#admin-settings-table').css('display', 'none');
        $('#admin-filters').css('display', 'none');
        $('#admin-logs-body').empty();
        $('#admin-pending-body').empty();
        $('#admin-users-body').empty();
        $('#admin-settings-body').empty();
        $('#admin-search-bar').val('');
        $('.admin-tab').removeClass('admin-tab-selected');
        $(this).addClass('admin-tab-selected');
      
        abortRequests();
        requests.push($.ajax({
          type: "POST",
          url: '/server_spaceApproval',
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            const newFragment = document.createDocumentFragment();
            data.forEach(function (item) {
              let formNode = '';
              formNode = '<form class="approve-space"><input type="checkbox"></form>';
              let newNode = document.createElement('tr');
              newNode.className = 'admin-pending-table-row';
              //newNode.setAttribute('data-id', item._id);
              let newNodeChild = document.createElement('td');
              let newNodeChildChild = document.createElement('img');
              newNodeChildChild.className = 'profile-picture';
              newNodeChildChild.src = item['picture'];
              newNodeChild.appendChild(newNodeChildChild);
              newNodeChild.appendChild(document.createTextNode(' ' + item['by']))
              newNode.appendChild(newNodeChild);

              newNodeChild = document.createElement('td');
              newNodeChild.textContent = item['email'];
              newNode.appendChild(newNodeChild);

              newNodeChild = document.createElement('td')
              newNodeChildChild = document.createElement('img');
              newNodeChildChild.className = 'profile-picture';
              newNodeChildChild.src = item['space_image'];
              newNodeChild.appendChild(newNodeChildChild);
              newNodeChild.appendChild(document.createTextNode(' ' + item['space_name']))
              newNode.appendChild(newNodeChild);

              newNodeChild = document.createElement('td');
              newNodeChild.textContent = item['space_description']
              newNode.appendChild(newNodeChild);

              newNodeChild = document.createElement('td');
              newNodeChild.innerHTML = formNode;
              newNode.appendChild(newNodeChild);
              newFragment.appendChild(newNode);
              //newNode.innerHTML = '<td><img class="profile-picture" src="' + item.picture + '"> ' + item.name + '</td><td>' + item.email + '</td><td>' + formNode + '</td>';
            });
            document.getElementById('admin-pending-body').appendChild(newFragment);
          }
        }));
      });

      $(document).on('click', '#admin-settings', function() {
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'none');
        $('#first-all').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#administrator-page').css('display', 'block');
        $('#admin-logs-table').css('display', 'none');
        $('#admin-users-table').css('display', 'none');
        $('#admin-users-pending').css('display', 'none');
        $('#admin-settings-table').css('display', 'table');
        $('#admin-filters').css('display', 'none');
        $('#admin-logs-body').empty();
        $('#admin-users-body').empty();
        $('#admin-settings-body').empty();
        $('#admin-pending-body').empty();
        $('#admin-search-bar').val('');
        $('.admin-tab').removeClass('admin-tab-selected');
        $(this).addClass('admin-tab-selected');
      });

      $(document).on('click', '.admin-logs-table-row', function() {
        $(this.nextElementSibling).toggle();
        if ($(this.nextElementSibling).is(':visible')) {
          $(this).find('.expand-log').animate(
            { deg: 0 },
            {
              duration: 80,
              step: function(now) {
                $(this).css({ transform: 'rotate(' + now + 'deg)' });
              }
            }
          );
        }
        else {
          $(this).find('.expand-log').animate(
            { deg: -90 },
            {
              duration: 80,
              step: function(now) {
                $(this).css({ transform: 'rotate(' + now + 'deg)' });
              }
            }
          );
        }
      });

      var loadLogTrigger = true;
      $('#admin-table-wrapper').on('wheel', function() {
        if (loadLogTrigger && $('#admin-logs-table').is(':visible') && document.getElementById("admin-table-wrapper").scrollHeight - $("#admin-table-wrapper").scrollTop() - $("#admin-table-wrapper").outerHeight() < 1) {
          loadLogHistory();
          loadLogTrigger = false;
        }
      });

      $('.admin-log-filters').on('click', function() {
        if (this.id != 'expand-message-filter') {
          $('#admin-logs-body').empty();
          last_loaded = '';
          chat_history_skip = 0;
          loadLogHistory();
        }
        else {
          if (!document.getElementById('expand-message-filter').checked) {
            $('.admin-logs-table-row-details').hide();
            $('.expand-log').css({transform: 'rotate(-90deg)'});
          }
          else {
            $('.admin-logs-table-row-details').show();
            $('.expand-log').css({transform: 'rotate(0deg)'});
          }
        }
      });

      $(document).on('change', '.user-status-select', function() {
        $(this.parentNode).submit();
      });

      $(document).on('submit', '.admin-change-user-status-form', function(e) {
        e.preventDefault();
        $.ajax({
          type: "POST",
          url: '/admin_change_user_status',
          dataType: "json",
          data: JSON.stringify({'user_id': this.parentElement.parentElement.getAttribute('data-id'), 'status': this.firstElementChild.value}), 
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            if (data['success'] == 'self') {
              window.location.href = "https://www.oneconnected.app";
            }
            popupSuccess();
           }
        });
      });

      $(document).on('submit', '.change-user-status-form', function(e) {
        e.preventDefault();
        socket.emit('change_user_status', {
          'user_id': this.closest('.space-members-list-item').getAttribute('data-id'),
          'status': this.firstElementChild.value
        });
      });

      socket.on('change_user_status', function (data) {
        if (data['user_id'] == user_id) {
          window.location.reload();
        }
        if (data['user'] == user_id) {
          popupSuccess();
        }
        if (space_admin || admin) {
          $(document.querySelector('.space-members-list-item[data-id="' + data['user_id'] + '"]').querySelector('.user-status-select')).val(data['status']);
        }
        member = document.querySelector('.member[data-id="' + data['user_id'] + '"]');
        if (data['status'] == 'banned') {
          member.remove();
        }
        else if (data['status'] == 'moderator') {
          if (!member.querySelector('.status-icon')) {
            const newNode = document.createElement('img');
            newNode.className = 'status-icon white-icon';
            newNode.src = '/static/images/moderator.svg';
            member.appendChild(newNode);
          }
        }
        else if (data['status'] == 'member') {
          member?.querySelector('.status-icon')?.remove();
        }
      });

      $('#directory-search-bar').keydown(function (e) {
        if (e.keyCode == 13) {
          e.preventDefault();
        }
      });

      $('#directory-search-bar').on('paste', function (e) {
        setTimeout(function () {
          $('#directory-search-bar').val($('#directory-search-bar').val().replace(/\r?\n|\r/g, ' '));
        }, 0);
      });

      $('#directory-search-bar').keyup(function (e) {
        const filter = document.getElementById("directory-search-bar").value.toUpperCase();
        if (filter != '') {
          document.querySelectorAll('.form-space').forEach(function(entry) {
            if(entry.textContent.toUpperCase().indexOf(filter) > -1) {
              $(entry).show();
            }
            else {
              $(entry).hide();
            }
          });
        }
        else {
          $('.form-space').show();
        }
      });

      $('#admin-search-bar').keydown(function (e) {
        if (e.keyCode == 13) {
          e.preventDefault();
        }
      });

      $('#admin-search-bar').on('paste', function (e) {
        setTimeout(function () {
          $('#admin-search-bar').val($('#admin-search-bar').val().replace(/\r?\n|\r/g, ' '));
        }, 0);
      });

      $('#admin-search-bar').keyup(function () {
        if (document.getElementById('admin-logs-table').style.display != 'none') {
          $('#admin-logs-body').empty();
          last_loaded = '';
          chat_history_skip = 0;
          loadLogHistory();
        }
        else if (document.getElementById('admin-users-table').style.display != 'none') {
          const filter = document.getElementById("admin-search-bar").value.toUpperCase();
          if (filter != '') {
            document.querySelectorAll('.admin-users-table-row').forEach(function(entry) {
              if(entry.textContent.toUpperCase().indexOf(filter) > -1) {
                $(entry).show();
              }
              else {
                $(entry).hide();
              }
            });
          }
          else {
            $('.admin-users-table-row').show();
          }
        }
        
      });

      $(document).on('click', '#exit-server-settings', function() {
        $('#home-page').css('display', 'block');
        $('#first-all').css('display', 'none');
        $('#user-page').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#administrator-page').css('display', 'none');
        $('#admin-logs-body').empty();
        $('#admin-users-body').empty();
        $('#admin-settings-body').empty();
        $('#admin-pending-body').empty();
      });
      
      /* Does not work for laptops or computers, need to check compatibility with wider-screen tablets */
      /* IMPORTANT TODO: if statement (for touchscreen with widths bigger than 768) that prevents desktop or swipe AND disable swipe when not on content page*/

      /* If width of device is greater than height (ipads), then landscape orient it and disable swiping (add && mobile to if statements*/
      $(document).on('click', '#open_channels', function() {
        if (mobile_column == 1) {
          showChannels();
        }
      });
      $(document).on('click', '#open_members', function() {
        if (mobile_column == 1) {
          showMembers();
        }
      });
      let touchstartX = 0;
      let touchendX = 0;
      let touchstartY = 0;
      let touchendY = 0;
      function checkDirection() {
        if (((touchstartX - touchendX) > 40) && (Math.abs(touchstartY - touchendY) < 60) && (mobile_column != 2) && mobile) {
          if (mobile_column == 1 ) {
            showMembers();
          }
          else if (mobile_column == 0) {
            hideChannels();
          }
        }
        
        if (((touchendX - touchstartX) > 40) && (Math.abs(touchstartY - touchendY) < 60) && (mobile_column != 0) && mobile) {
          if (mobile_column == 1) {
            showChannels();
          }
          else if (mobile_column == 2) {
            hideMembers();
          }
        }
      }

      function showMembers() {
        mobile_column = 2;
        // $('#chats').css("margin-left", "-220px");
        //   $('#chats').css("margin-right", "220px");
        //   $('#information').css("margin-left", "-220px");
        //   $('#information').css("margin-right", "220px");

        $('#members_header').animate({"margin-left":"-220px"}, 50);
        $('#members').animate({"margin-left":"-220px"}, 50);
          /* Maybe not needed (Lag?): */
          $('#chats').animate({"margin":"0px 220px 0px -220px"}, 50);
          $('#information').animate({"margin":"0px 220px 0x -220px"}, 50);

          
          $('#mobile_touch_overlay').css("display", "block");
          $('#mobile_touch_overlay').css("left", "0px");
          $('#mobile_touch_overlay').css("width", "calc(100vw - 220px)");
      }
      function hideMembers() {
        mobile_column = 1;
        

            // $('#chats').animate({"margin-right":"-110px"}, 25);
            // $('#information').animate({"margin-right":"-110px"}, 25);
            $('#chats').animate({"margin":"0px 0px 0px 0px"}, 50);
            $('#information').animate({"margin":"0px 0px 0x 0px"}, 50);
            $('#members').animate({"margin-left":"0px"}, 50);
            $('#members_header').animate({"margin-left":"0px"}, 50);
            // $('#chats').animate({"margin-left":"0px"}, 50);
            // $('#information').animate({"margin-left":"0px"}, 50);
            // $('#chats').animate({"margin-right":"0px"}, 20);
            // $('#information').animate({"margin-right":"0px"}, 20);
            $('#mobile_touch_overlay').css("display", "none");
      }
      function showChannels() {
        mobile_column = 0;
          // $('#chats').css("margin-left", "270px");
          // $('#chats').css("margin-right", "-270px");
          // $('#information').css("margin-left", "270px");
          // $('#information').css("margin-right", "-270px");

          $('#header').animate({"margin-right":"-270px"}, 50);
          $('#channels').animate({"margin-right":"-270px"}, 50);

          $('#chats').animate({"margin":"0px -270px 0px 270px"}, 50);
          $('#information').animate({"margin":"0px -270px 0x 270px"}, 50);
          
          $('#mobile_touch_overlay').css("display", "block");
          $('#mobile_touch_overlay').css("left", "270px");
          $('#mobile_touch_overlay').css("width", "calc(100vw - 270px)");
      }
      function hideChannels() {
        mobile_column = 1;

            $('#header').animate({"margin-right":"0px"}, 50);
            $('#channels').animate({"margin-right":"0px"}, 50);
            $('#chats').animate({"margin":"0px 0px 0px 0px"}, 50);
            $('#information').animate({"margin":"0px"}, 50);
            $('#mobile_touch_overlay').css("display", "none");
      } 
      function leaveContent() {
        // if Mobile, revert all when going to home page or space search page
        mobile_column = 1;
        $('#header').css("margin-right", "0px");
        $('#channels').css("margin-right", "0px");
        $('#chats').css("margin-left", "0px");
        $('#information').css("margin-left", "0px");
        $('#chats').css("margin-right", "0px");
        $('#information').css("margin-right", "0px");
        $('#members').css("margin-left", "0px");
        $('#members_header').css("margin-left", "0px");
        $('#chats').css("margin-left", "0px");
        $('#chats').css("margin-right", "0px");
        $('#information').css("margin-left", "0px");
        $('#information').css("margin-right", "0px");
        $('#mobile_touch_overlay').css("display", "none");
        $('#mobile_touch_overlay').css("left", "0px");
        $('#mobile_touch_overlay').css("width", "0px");
      }



      document.getElementById('chats').addEventListener('touchstart', e => {
        swipeStart(e);
      });

      document.getElementById('chats').addEventListener('touchend', e => {
          swipeEnd(e);
      });
      document.getElementById('channels').addEventListener('touchstart', e => {
        swipeStart(e);
      });
      document.getElementById('channels').addEventListener('touchend', e => {
          swipeEnd(e);
      });
      document.getElementById('members').addEventListener('touchstart', e => {
        swipeStart(e);
      });
      document.getElementById('members').addEventListener('touchend', e => {
          swipeEnd(e);
      });
      document.getElementById('mobile_touch_overlay').addEventListener('touchstart', e => {
        swipeStart(e);
      });
      document.getElementById('mobile_touch_overlay').addEventListener('touchend', e => {
          swipeEnd(e);
      });

      $(document).on('click', '#profile', function() {
        $('#user-page').css('display', 'block');
        $("#user-page").animate({opacity: '1'}, 100);
        $('#space-settings').css('display', 'none');
        $.ajax({
          type: "POST",
          url: '/profile',
          dataType: "json",
          contentType: 'application/json;charset=UTF-8',
          success: function(data){
          }
        });
      });

      // Switch back to Desktop version if on Desktop
      $(window).resize(function() {
        if (iOSSafari || isIOSChrome) {
          $('#mobile_touch_overlay').css('height', 'calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px)');
          $('#content').css('grid-template-rows', '48px calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px - 48px)');

          // TODO: Make every div that has a calc(100vh) in the CSS be added here, as well as in the if iOSSafari above
          // $('#home-page').css('height', 'calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px)');
          // $('#settings-pages').css('grid-template-rows', '48px calc(' + document.getElementById('footer').getBoundingClientRect().top + 'px - 48px - var(--sab))');
        }

          //$('#footer').css('top', document.getElementById('footer').getBoundingClientRect().top + 'px');
        if ($(window).width() > 768) {
          leaveContent();
          mobile = false;
        } // h
        else {
          mobile = true;
        }
      });
      
      $(document).on('click', '#mobile_touch_overlay', function() {
        if (mobile_column == 0) {
          hideChannels();
          }
        else if (mobile_column == 2) {
          hideMembers();
        }
      });
      
      $(document).on('click', '#close-user-page', function() {
        $("#user-page").animate({opacity: '0'}, 100);
        setTimeout(function() {
          $('#user-page').css('display', 'none');
        }, 100);
      });

      $(document).on('click', '.message-container, .message-container-combine', function() {
        selected_message = this.id;
      });

      $(document).on('click', '.section', function(e) {
        selected_section = this.id;
        if (e.target.className != 'create-room-button') {
          let children = this.nextElementSibling.children;
          if (this.className.includes("collapsed")) {
            $(this.firstElementChild.firstElementChild.firstElementChild).animate(
              { deg: 0 },
              {
                duration: 80,
                step: function(now) {
                  $(this).css({ transform: 'rotate(' + now + 'deg)' });
                }
              }
            );
            this.classList.remove("collapsed");
            for (let i = 0; i < children.length; i++) {
              children[i].style.display = "block";
            }
            document.getElementById(current_room).style.display = "block";
          }
          else {
            $(this.firstElementChild.firstElementChild.firstElementChild).animate(
              { deg: -90 },
              {
                duration: 80,
                step: function(now) {
                  $(this).css({ transform: 'rotate(' + now + 'deg)' });
                }
              }
            );
            this.classList.add('collapsed');
            for (let i = 0; i < children.length; i++) {
              children[i].style.display = "none";
            }
            document.getElementById(current_room).style.display = "block";
          }
        };
      });
      
      $(document).on('click', '.member', function(e) {
        if (this.getAttribute('data-id') != selected_user) {
          if (!!document.getElementById("profile-popup")) {
            $('#profile-popup').remove();
            $('.member').css('background-color', '');
            $('.member').addClass('pointer');
          }
          selected_user = this.getAttribute('data-id');
          abortRequests();
          requests.push($.ajax({
            type: "POST",
            url: '/open_member_profile',
            dataType: "json",
            data: JSON.stringify({'user_id': selected_user}), 
            contentType: 'application/json;charset=UTF-8',
            success: function(data) {
              let member = document.querySelector('.member[data-id="' + selected_user + '"]');
              let newNode = document.createElement('div');
              newNode.id = 'profile-popup';
              document.getElementById('overlay').appendChild(newNode);
              member.className = 'member';
              member.style.backgroundColor = 'var(--selected-color)';
              document.getElementById('profile-popup').innerHTML = '<ul id="profile-list"><li id="profile-picture-list"><img id="popup-picture" alt="!"></li><li id="profile-name"></li><li id="profile-email"></li><div id="joined-table"></div>';
              document.getElementById('popup-picture').src = data['picture'];
              document.getElementById('profile-name').textContent = data['name'];
              document.getElementById('profile-email').textContent = data['email'];
              newFragment = document.createDocumentFragment();
              data['joined'].forEach(function(item) {
                newNode = document.createElement('div');
                newNode.className = 'icons-wrapper pointer';
                newNode.innerHTML = '<img class="joined-icons"><div class="joined-icons-tooltip"></div>';
                newNode.firstElementChild.src = item[0];
                newNode.firstElementChild.setAttribute('data-id', item[1]);
                newNode.firstElementChild.nextElementSibling.textContent = item[2];
                newFragment.appendChild(newNode);
              });
              document.getElementById("joined-table").append(newFragment);
              if (!mobile) {
                if (member.getBoundingClientRect().top < $(window).height() / 2) {
                  document.getElementById('profile-popup').style.top = member.getBoundingClientRect().top + 'px';
                }
                else if (member.getBoundingClientRect().top + member.offsetHeight + 6 > document.getElementById('footer').getBoundingClientRect().top) {
                  document.getElementById('profile-popup').style.top = (document.getElementById('footer').getBoundingClientRect().top - 6 - document.getElementById('profile-popup').offsetHeight) + 'px';
                }
                else {
                  document.getElementById('profile-popup').style.top = (member.getBoundingClientRect().top - document.getElementById('profile-popup').offsetHeight + member.offsetHeight) + 'px';
                }
              }
            }
          }));
        }
        else if (!!document.getElementById("profile-popup") && $('.member').is(e.target) || $('.member').is(e.target.parentNode)) {
          $('#profile-popup').remove();
          $('.member').css('background-color', '');
          $('.member').addClass('pointer');
          selected_user = '';
        }
      });

      $(document).on('click', '.joined-icons', function() {
        joinSpace(this.getAttribute('data-id'));
      });

      $(document).on('click', '#space-search-button', function() {
        $('#space-search').css('display', 'block');
        $('#space-settings').css('display', 'none');
        $('#user-page').css('display', 'none');
        $("#space-search").animate({opacity: '1'}, 100);
      });
        
      $(document).on('click', '#close-space-search-button', function() {
        $('#first-all').show();
        $("#space-search").animate({opacity: '0'}, 100);
        setTimeout(function() {
          $('#space-search').css('display', 'none');
        }, 100);
      });

      $(document).on('click', '.form-space', function() {
        $("#space-search").css('pointer-events', 'none');
        joinSpace(this.getAttribute('data-id'));
      });

      $('#chat').scroll(function() { //$('#chat').scrollTop() + $('#chat').height();
        if (Math.abs($('#chat').scrollTop()) == document.getElementById("chat").scrollHeight - document.getElementById("chat").offsetHeight) {  
          loadChatHistory();
        }
      });

      let message_input = document.getElementById("message_input");
      message_input.oninput = function() {
        message_input.style.height = "";
        message_input.style.height = Math.min(message_input.scrollHeight, 300) + "px";
      }
      
      $(message_input).keypress(function (e) {
        if(e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          $(document.getElementById('message_input_form')).submit();
        }
        else {
          isTyping();
        }
      });
      
      document.getElementById('message_input_form').onsubmit = function (e) {
        e.preventDefault();
        let message = message_input.value.trim();
        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight; 
        stoppedTyping();
        clearTimeout(timeout);
        if (message.length) {
          let messageMoment = moment();
          const newNode = document.createElement('div');
          newNode.setAttribute('data-datetime', messageMoment.format())
          newNode.setAttribute('data-user', user_id)
          newNode.style.opacity = 0.5;
          const latestMessage = $('#messages').children()/*.not('.temporary-message')*/.last();
          if (latestMessage.data('user') == user_id && messageMoment.diff(moment(latestMessage.data('datetime'))) < 180000) {
            newNode.className = 'message-container-combine temporary-message';
            newNode.innerHTML = '<p class="message-combine-time">' + messageMoment.format('h:mm A') + '</p><p class="message-combine"></p>';
            newNode.querySelector('.message-combine').innerHTML = '<span>' + parseMarkdown(escapeHTML(message)) + '</span>';
          }
          else {
            newNode.className = 'message-container temporary-message';
            messageMoment = 'at ' + messageMoment.format('h:mm A');
            newNode.innerHTML = '<img class="profile-picture pointer" src="' + user_picture + '" alt="!"><p class="message-title"><span class="name pointer"><b>' + user_name + ' </b></span><span class="datetime">' + messageMoment + '</span></p><p class="message"></p>';
            newNode.querySelector('.message').innerHTML = '<span>' + parseMarkdown(escapeHTML(message)) + '</span>';
          }
          document.getElementById('messages').append(newNode);
          socket.emit('send_message', {
            room_id: current_room,
            message: message
          });
        }
        message_input.setAttribute("style", "");
        message_input.value = ''; //put placeholder message (message is loading but is faded out to account for lag time or disconnected if wanted)
        message_input.focus();
      }

      $('#email_to_input').focusin(function (e) {
        if (document.getElementById('email_to_input').value != '') {
          document.getElementById('suggested_emails').style.display = 'block';
          if ($('#suggested_emails').height() < 5) {
            document.getElementById('suggested_emails').style.display = 'none';
          }
        }
      });

      $('#email_to_input').keypress(function (e) {
        if(e.which === 13 && !e.shiftKey) {
          e.preventDefault(); 
        }
      });

      $('#email_to_input').keyup(function (e) {
        if (e.which === 32 || (e.which === 13 && !e.shiftKey)) {
          let email = document.getElementById('email_to_input').value.replace(/\s+/g, '');
          if (/\S+@\S+\.\S+/.test(email) || email == 'Everyone') {
            emailAccepted(email);
            document.getElementById('email_to_input').value = '';
          }
          else if (email != '') {
            let newNode = document.createElement('div');
            newNode.className = 'rejected_email_bubble';
            let newNodeChild = document.createElement('span');
            newNodeChild.className = 'rejected_email';
            newNodeChild.textContent = email;
            newNode.appendChild(newNodeChild);
            newNodeChild = document.createElement('img');
            newNodeChild.className = 'delete-email-icon pointer'
            newNodeChild.src = '/static/images/x.svg';
            newNode.appendChild(newNodeChild);
            document.getElementById('email_to_list').insertBefore(newNode, document.getElementById('email_to_input_span'));
            document.getElementById('email_to_input').value = '';
          }
        }
        if (document.getElementById('email_to_input').value != '') {
          document.getElementById('suggested_emails').style.display = 'block';
          let hide = true;
          const filter = document.getElementById("email_to_input").value.toUpperCase();
          document.querySelectorAll('.suggested_email').forEach(function(suggested_email) {
            if(suggested_email.textContent.toUpperCase().indexOf(filter) > -1) {
              suggested_email.style.display = 'block';
              hide = false;
            }
            else {
              suggested_email.style.display = 'none';
            }
          });
          if (hide) {
            document.getElementById('suggested_emails').style.display = 'none';
          }
        }
        else {
          document.getElementById('suggested_emails').style.display = 'none';
        }
      });

      $(document).on('click', '.delete-email-icon', function() {
        this.parentNode.remove();
      });

      $(document).on('click', '.suggested_email', function() {
        if (this.textContent == 'Everyone') {
          emailAccepted('Everyone');
        }
        else {
          emailAccepted(this.getAttribute('data-email'));
        }
        document.getElementById('email_to_input').value = '';
        document.getElementById('suggested_emails').style.display = 'none';
      });

      $(document).on('click', '#submit_email', function() {
        let recipient_list = [];
        document.querySelectorAll('.accepted_email').forEach(function (e) {
          recipient_list.push(e.textContent);
        });
        if (/\S+@\S+\.\S+/.test(document.getElementById('email_to_input').value)) {
          recipient_list.push(document.getElementById('email_to_input').value);
        }
        if (recipient_list.length != 0) {
          $.ajax({
            type: 'POST',
            url: '/send_email',
            dataType: 'json',
            data: JSON.stringify({'to': recipient_list, 'subject': document.getElementById('email_subject_input').value, 'message': document.getElementById('email_message_input').value, 'room_id': current_room}),
            contentType: 'application/json;charset=UTF-8',
            success: function(data) {
              socket.emit('sent_email', {
                room_id: current_room
              })
            }
          });
          $('.accepted_email_bubble').remove();
          $('.rejected_email_bubble').remove();
          document.getElementById('email_to_input').value = '';
          document.getElementById('email_subject_input').value = '';
          document.getElementById('email_message_input').value = '';
        }
      });

      // document.getElementById('email_input_form').onsubmit = function (e) {
      //   e.preventDefault();
      //   let recipient_list = [];
      //   document.querySelectorAll('.accepted_email').forEach(function (e) {
      //     recipient_list.push(e.textContent);
      //   });
      //   if (/\S+@\S+\.\S+/.test(document.getElementById('email_to_input').value)) {
      //     recipient_list.push(document.getElementById('email_to_input').value);
      //   }
      //   if (recipient_list.length != 0) {
      //     $.ajax({
      //       type: 'POST',
      //       url: '/send_email',
      //       dataType: 'json',
      //       data: JSON.stringify({'to': recipient_list, 'subject': document.getElementById('email_subject_input').value, 'message': document.getElementById('email_message_input').value, 'room_id': current_room}),
      //       contentType: 'application/json;charset=UTF-8',
      //       success: function(data) {
      //         socket.emit('sent_email', {
      //           room_id: current_room
      //         })
      //       }
      //     });
      //     $('.accepted_email_bubble').remove();
      //     $('.rejected_email_bubble').remove();
      //     document.getElementById('email_to_input').value = '';
      //     document.getElementById('email_subject_input').value = '';
      //     document.getElementById('email_message_input').value = '';
      //   }
      // }

      $(document).on('click', '.expand-recipient-list', function() {
        if (this.getAttribute('data-expanded') == 'false') {
          $(this).css('transform', 'rotate(180deg)');
          this.setAttribute('data-expanded', 'true');
          this.previousElementSibling.style.whiteSpace = 'initial';
        }
        else {
          $(this).css('transform', 'rotate(0deg)');
          this.setAttribute('data-expanded', 'false');
          this.previousElementSibling.style.whiteSpace = 'nowrap';
        }
      });

      $(document).on('click', '.edit-message', function() {
        let message_id = this.parentElement.parentElement.id;
        let message = this.parentElement.parentElement.getAttribute('data-markdown');
        $(this.parentElement.previousElementSibling).hide();
        $(this.parentElement.previousElementSibling).after('<form class="message_edit_input_form"><textarea class="message_edit" rows="1" placeholder="Remove message" maxlength="2000">' + message + '</textarea></form>');
        this.parentElement.previousElementSibling.firstChild.setAttribute("style", "height:" + (this.parentElement.previousElementSibling.firstChild.scrollHeight) + "px;overflow-y:hidden;");
      });

      $(document).on('input', '.message_edit', function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
      });

      $(document).on('keypress', '.message_edit', function(e) {
        if(e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          $(this.parentNode).submit();
        }
      });

      $(document).on('submit', '.message_edit_input_form', function(e) {
        e.preventDefault();
        let message_id = this.parentNode.id;
        let edit = this.firstChild.value.trim();
        if (edit.length && edit != this.parentElement.getAttribute('data-markdown')) {
          let combine = null;
          if(this.parentElement.className == 'message-container') {
            combine = 'false';
          } 
          else {
            combine = 'true';
          }
          socket.emit('edited_message', {
            room_id: current_room,
            message_id: message_id,
            combine: combine,
            edit: edit
          });
        }
        else if (edit.length == 0) {
          //call delete message
        }
        $(this.previousElementSibling).show();
        $(this).remove();
      });

      $(document).on('click', '.room', function(e) {
        joinRoom(this.id);
      });

      $(document).on('click', '.special-room', function(e) {
        joinRoom(this.id, true);
      });

      $(document).on('contextmenu', '.room', function (e) {
        hideSecondLayer();
        if (space_admin || admin) {
          selected_room = this.id;
          document.getElementById('room-menu').style.top = mouseY(event) + 'px';
          document.getElementById('room-menu').style.left = mouseX(event) + 'px';
          $(document.getElementById('room-menu')).show();
          document.getElementById('new-channel-name').value = document.getElementById(selected_room).textContent;
          e.preventDefault();
        }
      });

      document.getElementById('create-room-form').onsubmit = function (e) {
        e.preventDefault();
        let room_name = document.getElementById('room-name').value.trim();
        let section_id = selected_section;
        if (room_name.length) {
          $.ajax({
            type: 'POST',
            url: '/create_room',
            dataType: 'json',
            data: JSON.stringify({'room_name': room_name, 'section_id': section_id}),
            contentType: 'application/json;charset=UTF-8',
            success: function(room) {
              socket.emit('created_room', {
                room_id: room['_id']['$oid'],
                name: room_name,
                section_id: section_id
              });
              document.getElementById("create-room").style.display = "none";
            }
          });
        }
      }

      document.getElementById('create-section-form').onsubmit = function (e) {
        e.preventDefault();
        let section_name = document.getElementById('section-name').value.trim();
        if (section_name.length) {
          $.ajax({
            type: 'POST',
            url: '/create_section',
            dataType: "json",
            data: JSON.stringify({'section_name': section_name}),
            contentType: 'application/json;charset=UTF-8',
            success: function(section) {
              socket.emit('created_section', {
                section_id: section['_id']['$oid'],
                name: section_name
              });
              document.getElementById("create-section").style.display = "none";
            }
          });
        }
      }

      $(document).on('contextmenu', '.section', function (e) {
        hideSecondLayer();
        if (space_admin || admin) {
          selected_section = this.id;
          document.getElementById('section-menu').style.top = mouseY(event) + 'px';
          document.getElementById('section-menu').style.left = mouseX(event) + 'px';
          $(document.getElementById('section-menu')).show();
          document.getElementById('new-section-name').value = document.getElementById(selected_section).querySelector('.section-name').textContent;
          e.preventDefault();
        }
      });

      $(document).on('click', '.space', function() {
        if (current_space != this.id) {
          $(document.getElementById(current_space)).closest('.space-wrapper').find('.active-space').attr('style', '');
          $(document.getElementById(current_space)).attr('style', '');
          $(this).css('border-radius', '3px');
          $(this).closest('.space-wrapper').find('.active-space').css({width: '39px', WebkitTransition: 'width 0.1s ease-out', MozTransition: 'width 0.1s ease-out', MsTransition: 'width 0.1s ease-out', OTransition: 'width 0.1s ease-out', transition: 'width 0.1s ease-out'});
          current_space = this.id;
          space();
        }
        else {
          $('#space-search').hide();
          $('#first-all').show();
        }
      });

      document.getElementById('create-space-form').onsubmit = function (e) {
        alert("Your request to make a space has been received. After being reviewed by school officials, your request will be approved and your space will be displayed on the Club Directory.")
        let space_name = document.getElementById('space-name').value.trim();
        let space_image = document.getElementById('space-picture').value.trim();
        let space_description = document.getElementById('space-description').value.trim();
        $.ajax({
          type: 'POST',
          url: '/approve_space',
          dataType: "json",
          data: JSON.stringify({'space_name': space_name, 'space_image': space_image, 'space_description': space_description}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            if (data['success'] == 'true'){
              alert("success")
            }
          }
        })
      }
        /*Used for the creation of spaces (once approved by school official). gonna be used for space verification
        e.preventDefault();
        let space_name = document.getElementById('space-name').value.trim();
        let space_image = document.getElementById('space-picture').value.trim();
        let space_description = document.getElementById('space-description').value.trim();
        if (space_name.length) { 
          $.ajax({
            type: 'POST',
            url: '/create_space',
            dataType: "json",
            data: JSON.stringify({'space_name': space_name, 'space_image': space_image, 'space_description': space_description}),
            contentType: 'application/json;charset=UTF-8',
            success: function(data) {
              if ('success' in data) {
                alert('You may only create up to 3 spaces.');
              }
              else {
                document.getElementById("create-space").style.display = "none";
                $(document.getElementById(current_space)).closest('.space-wrapper').find('.active-space').attr('style', '');
                $(document.getElementById(current_space)).attr('style', '');
                let newNode = document.createElement('li');
                newNode.className = 'space-wrapper';
                let newNodeChild = document.createElement('img');
                newNodeChild.className = 'space pointer';
                newNodeChild.id = data.space_id;
                newNodeChild.setAttribute('data-name', space_name);
                newNodeChild.style.borderRadius = '3px';
                newNodeChild.src = data.space_image;
                newNode.appendChild(newNodeChild);
                newNodeChild = document.createElement('div');
                newNodeChild.className = 'active-space';
                newNodeChild.style.width = '39px'
                newNode.appendChild(newNodeChild);
                referenceNode = document.getElementById('space_align_helper');
                referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
                current_space = data.space_id;
                space();
              }
            }
          });
        }
      }
*/
      $(document).on('click', '#space-settings-button', function() {
        let container = document.getElementById('space-settings-popup');
        if (container.style.display == 'block') {
          container.style.display = 'none';
        }
        else {
          container.style.display = 'block';
        }
      });

      function spaceSettingsSelectionSwitch(selected_settings, selected_expand) {

        if ($(selected_settings).css('display') == 'none') {
          $(document.getElementById("space-settings-general")).attr('style', '');
          $(document.getElementById("space-settings-themes")).attr('style', '');
          $(document.getElementById("space-settings-members")).attr('style', '');
          document.getElementById("space-settings-general-selection").style.display = "none";
          document.getElementById("space-settings-themes-selection").style.display = "none";
          document.getElementById("space-settings-members-selection").style.display = "none";
          $(selected_expand).attr('style', 'background-color: var(--selected-color) !important');
          selected_settings.style.display = 'block';
        }
      }

      $(document).on('click', '#space-settings-themes', function() {
        spaceSettingsSelectionSwitch(document.getElementById('space-settings-themes-selection'), document.getElementById("space-settings-themes"));
      });

      $(document).on('click', '#space-settings-members', function() {
        spaceSettingsSelectionSwitch(document.getElementById('space-settings-members-selection'), document.getElementById("space-settings-members"));
        // let container = document.getElementById('space-settings-members-selection');
        // if ($(container).css('display') == 'none') {

        //   // $(document.getElementById('space-settings-general')).css('background-color') = 'transparent';
        //   // $(this).css('background-color') = "#43474d!important";
        //   // $(document.getElementById("space-settings-general-selection")).css('display') = "none";
        //   // $(container).css('display') = "block";

        //   $(document.getElementById("space-settings-general")).attr('style', '');
        //   $(document.getElementById("space-settings-members")).attr('style', 'background-color: #43474d !important');
        //   document.getElementById("space-settings-general-selection").style.display = "none";
        //   container.style.display = 'block';
        // }
      });

      $(document).on('click', '#space-settings-general', function() {
        spaceSettingsSelectionSwitch(document.getElementById('space-settings-general-selection'), document.getElementById("space-settings-general"));

        // let container = document.getElementById('space-settings-general-selection');
        // if ($(container).css('display') == 'none') {

        //   // $(document.getElementById('space-settings-members')).css('background-color') = 'transparent';
        //   // $(this).css('background-color') = "#43474d!important";
        //   // $(document.getElementById("space-settings-members-selection")).css('display') = "none";
        //   // $(container).css('display') = "block";

        //   $(document.getElementById("space-settings-members")).attr('style', '');
        //   $(document.getElementById("space-settings-general")).attr('style', 'background-color: #43474d !important');
        //   document.getElementById("space-settings-members-selection").style.display = "none";
        //   container.style.display = 'block';
        // }
      });


      $(document).on('click', '#edit-space-button', function() {
        $('#space-settings').show();
        $('#first-all').css('display', 'none');
      });

      $(document).on('click', '#invite-link-button', function() {
        socket.emit("space_invite"); 
      });

      socket.on("space_invite", function (data) {    
        navigator.clipboard.writeText('https://www.oneconnected.app/invite/' + data['_id']);
        if (data['user'] == user_id) {
          popupSuccess();
        }
        if (!data['exists'] && (space_admin || admin)) {
          const newNode = document.createElement('div');
          newNode.id = data['_id'];
          newNode.className = 'space-invites-list-item';
          newNode.innerHTML = '<span class="invite-information-wrapper"><img class="profile-picture"><span class="invite-information"></span></span><span class="invite-code"></span><span class="revoke-link"><img class="pointer white-icon revoke-invite-button" src="/static/images/x.svg"><span>';
          newNode.querySelector('.profile-picture').src = data['picture'];
          newNode.querySelector('.invite-information').textContent = data['name'] + ' (' + data['email'] + ')';
          newNode.querySelector('.invite-code').textContent = data['_id'];
          document.getElementById('space-invites-list').append(newNode);
        }
      });

      document.getElementById('edit-space-profile').onsubmit = function (e) {
        e.preventDefault();
        const space_name_input = document.getElementById('edit-space-name-input');
        const space_picture_input = document.getElementById('edit-space-picture-input');
        const space_description_input = document.getElementById('edit-space-description-input');
        if (space_name_input.value.trim() != space_name_input.getAttribute('data-pre') || space_picture_input.value.trim() != space_picture_input.getAttribute('data-pre') || space_description_input.value.trim() != space_description_input.getAttribute('data-pre')) {
          socket.emit('edit_space_profile', {
            'space_name': space_name_input.value.trim(),
            'space_picture': space_picture_input.value.trim(),
            'space_description': space_description_input.value.trim()
          });
        }
      }
      
      socket.on('edit_space_profile', function(data) {
        if (data['user_id'] == user_id) {
          popupSuccess();
          document.activeElement.blur();
        }
        const space_name_input = document.getElementById('edit-space-name-input');
        const space_picture_input = document.getElementById('edit-space-picture-input');
        const space_description_input = document.getElementById('edit-space-description-input');
        space_name_input.setAttribute('data-pre', data['space_name']);
        document.getElementById('header_text').textContent = data['space_name'];
        space_picture_input.setAttribute('data-pre', data['space_picture']);
        space_picture_input.value = data['space_picture'];
        document.getElementById(current_space).src = data['space_picture'];
        space_description_input.setAttribute('data-pre', data['space_description']);
        formSpace = document.querySelector('.form-space[data-id="' + current_space + '"]');
        formSpace.querySelector('.directory-space-img').src = data['space_picture'];
        formSpace.querySelector('.directory-space-description').textContent = data['space_description'];
        formSpace.querySelector('.directory-space-title').textContent = data['space_name'];
      });

      $(document).on('click', '#close-space-settings-button', function() {
        $('#space-settings').hide();
        $('#first-all').css('display', 'block');
      });

      let createSpaceModal = document.getElementById("create-space");
      $(document).on('click', '#create-space-button', function() {
        createSpaceModal.style.display = "block";
      });

      $(document).on('click', '#close-create-space', function() {
        createSpaceModal.style.display = "none";
      });

      let createRoomModal = document.getElementById("create-room");
      $(document).on('click', '.create-room-button', function() {
        createRoomModal.style.display = "block";
      });

      $(document).on('click', '#close-create-room', function() {
        createRoomModal.style.display = "none";
      });

      let createSectionModal = document.getElementById("create-section");
      $(document).on('click', '#create-section-button', function() {
        createSectionModal.style.display = "block";
      });
      
      $(document).on('click', '#close-create-section', function() {
        createSectionModal.style.display = "none";
      });

      let deleteSpaceModal = document.getElementById("confirm-delete-space");
      $(document).on('click', '#delete-space', function() {
        deleteSpaceModal.style.display = "block";
      });

      deleteSpaceModal.onsubmit = function (e) {
        e.preventDefault();
        if (document.getElementById('confirm-space-name').value == document.getElementById('header_text').textContent) {
          $.ajax({
            type: 'POST',
            url: '/delete_space',
            contentType: 'application/json;charset=UTF-8',
            success: function (delete_space) {
              deleteSpaceModal.style.display = 'none';
              socket.emit('deleted_space')
            }
          });
        }
      }
      
      $(document).on('click', '#close-confirm-delete-space', function() {
        deleteSpaceModal.style.display = "none";
      });

      let leaveSpaceModal = document.getElementById("confirm-leave-space");
      $(document).on('click', '#leave-space', function() {
        leaveSpaceModal.style.display = "block";
      });

      $(document).on('click', '#confirm-leave-space-button', function() {
        const formSpace = document.querySelector('.form-space[data-id="' + current_space + '"]').querySelector('.directory-space-joined-status')
        original = formSpace.getAttribute('data-original');
        formSpace.textContent = original;
        if (original == 'Invite Only') {
          formSpace.className = 'directory-space-joined-status invite-status';
        }
        else {
          formSpace.className = 'directory-space-joined-status open-status';
        }
        $.ajax({
          type: 'POST',
          url: '/leave_space',
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            leaveSpaceModal.style.display = 'none';
            window.history.pushState('', '', '/school'); //l
            $('#first-all').css('display', 'none');
            $("#home-page").show();
            $("#" + current_space).parent().remove();
          }
        });
      });
      
      $(document).on('click', '.revoke-link', function() {
        socket.emit('revoke_link', {
          'invite_id': this.parentElement.id
        });
      });

      socket.on('revoke_link', function(data) {
        if (space_admin || admin) {
          document.getElementById(data['invite_id']).remove();
        }
      });

      $(document).on('click', '#close-confirm-leave-space', function() {
        leaveSpaceModal.style.display = "none";
      });

      let deleteSectionModal = document.getElementById("confirm-delete-section");
      $(document).on('click', '#delete-section', function() {
        deleteSectionModal.style.display = "block";
      });

      $(document).on('click', '#confirm-delete-section-button', function() {
        const section_id = selected_section;
        $.ajax({
          type: 'POST',
          url: '/delete_section',
          dataType: "json",
          data: JSON.stringify({'section_id': section_id}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            deleteSectionModal.style.display = 'none';
            if (data['success'] == 'true') {
              socket.emit('deleted_section', {
                section_id: section_id
              });
            }
            else {
              alert('There must be at least one section.');
            }
          }
        });
      });
      
      $(document).on('click', '#close-confirm-delete-section', function() {
        deleteSectionModal.style.display = "none";
      });

      let deleteChannelModal = document.getElementById("confirm-delete-channel");
      $(document).on('click', '#delete-room', function() {
        deleteChannelModal.style.display = "block";
      });

      $(document).on('click', '#confirm-delete-channel-button', function() {
        const deleted_room = selected_room;
        const deleted_room_section = $('#' + deleted_room).attr('data-section');
        $.ajax({
          type: "POST",
          url: '/delete_room',
          dataType: "json",
          data: JSON.stringify({'room_id': deleted_room, 'section_id': deleted_room_section}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            deleteChannelModal.style.display = "none";
            if (data['success'] == 'true') {
              socket.emit('deleted_room', {
                room: deleted_room
              });
            }
            else {
              alert('Spaces must have at least one room');
            }
          }
        });
      });
      
      $(document).on('click', '#close-confirm-delete-channel', function() {
        deleteChannelModal.style.display = "none";
      });

      let deleteMessageModal = document.getElementById("confirm-delete-message");
      $(document).on('click', '.delete-message', function() {
        deleteMessageModal.style.display = "block";
      });

      $(document).on('click', '#confirm-delete-message-button', function() {
        let message_id = selected_message;
        $.ajax({
          type: 'POST',
          url: '/delete_message',
          dataType: 'json',
          data: JSON.stringify({'message_id': message_id, 'room_id': current_room}),//
          contentType: 'application/json;charset=UTF-8',
          success: function (deleted_message) {
            deleteMessageModal.style.display = "none";
            socket.emit('delete_message', {'message_id': message_id, 'room_id': current_room});
          }
        });
      });
      
      $(document).on('click', '#close-confirm-delete-message', function() {
        deleteMessageModal.style.display = "none";
      });

      let reportMessageModal = document.getElementById("confirm-report-message");
      $(document).on('click', '.report-message', function() {
        reportMessageModal.style.display = "block";
      });

      reportMessageModal.onsubmit = function (e) {
        e.preventDefault();
        $.ajax({
          type: "POST",
          url: '/report_message',
          dataType: "json",
          data: JSON.stringify({'message_id': selected_message, 'note': $.trim($('#report-message-note').val())}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            reportMessageModal.style.display = "none";
            if (data['success'] == 'true') {
              popupSuccess();
            }
            else if (data['success'] == 'many') {
              alert("Message has already been reported.");
            }
            else {
              alert("Your report failed.");
            }
          }
        });
      }
      
      $(document).on('click', '#close-confirm-report-message', function() {
        reportMessageModal.style.display = "none";
      });

      let editChannelModal = document.getElementById("edit-channel-modal");
      $(document).on('click', '#edit-room', function() {
        editChannelModal.style.display = "block";
      });

      document.getElementById('edit-channel-form').onsubmit = function (e) {
        e.preventDefault();
        socket.emit('edit_channel', {
          room_id: selected_room,
          room_name: document.getElementById('new-channel-name').value.trim()
        });
      }

      socket.on('edit_channel', function (data) {
        editChannelModal.style.display = "none";
        document.getElementById(data['room_id']).textContent = data['room_name'];
      });
      
      $(document).on('click', '#close-edit-channel', function() {
        editChannelModal.style.display = "none";
      });

      let editSectionModal = document.getElementById("edit-section-modal");
      $(document).on('click', '#edit-section', function() {
        editSectionModal.style.display = "block";
      });

      document.getElementById('edit-section-form').onsubmit = function (e) {
        e.preventDefault();
        socket.emit('edit_section', {
          section_id: selected_section,
          section_name: document.getElementById('new-section-name').value.trim()
        });
      }

      $(document).on('click', '#edit-space-invite-switch', function() {
        $("#edit-space-invite-switch").prop('disabled', true);
        socket.emit('edit_space_invite_switch', {
          invite_only: document.getElementById('edit-space-invite-switch').checked
        });
      });

      socket.on('edit_space_invite_switch', function(data) {
        document.getElementById('edit-space-invite-switch').checked = data['invite_only'];
        if (data['user_id'] == user_id) {
          popupSuccess();
          setTimeout(function() {
            $("#edit-space-invite-switch").prop('disabled', false);
          }, 1000);
        }
      });

      socket.on('edit_section', function(data) {
        editSectionModal.style.display = "none";
        document.getElementById(data['section_id']).firstElementChild.firstElementChild.nextSibling.textContent = data['section_name'];
      });
      
      $(document).on('click', '#close-edit-section', function() {
        editSectionModal.style.display = "none";
      });

      // confirm-delete-message confirm-report-message edit-channel
      window.onclick = function(event) {
        if (event.target == createRoomModal) {
          createRoomModal.style.display = "none";
        }
        if (event.target == createSpaceModal) {
          createSpaceModal.style.display = "none";
        }
        if (event.target == createSectionModal) {
          createSectionModal.style.display = "none";
        }
        if (event.target == deleteSpaceModal) {
          deleteSpaceModal.style.display = "none";
        }
        if (event.target == leaveSpaceModal) {
          leaveSpaceModal.style.display = "none";
        }
        if (event.target == deleteSectionModal) {
          deleteSectionModal.style.display = "none";
        }
        if (event.target == deleteChannelModal) {
          deleteChannelModal.style.display = "none";
        }
        if (event.target == deleteMessageModal) {
          deleteMessageModal.style.display = "none";
        }
        if (event.target == reportMessageModal) {
          deleteChannelModal.style.display = "none";
        }
        if (event.target == editChannelModal) {
          editChannelModal.style.display = "none";
        }
        if (event.target == editSectionModal) {
          editSectionModal.style.display = "none";
        }
      }

      $("#chat").on('mouseenter', '.message-container-combine', function(){
        $(this).find(".message-combine-time").css("visibility", "visible");
      });

      $("#chat").on('mouseleave', '.message-container-combine', function(){
        $(this).find(".message-combine-time").css("visibility", "hidden");
      });

      socket.on('sorted_sections', function (data) {
        data.section_list.forEach(function(section_id) {
          document.getElementById(section_id).parentElement.parentElement.appendChild(document.getElementById(section_id).parentElement);
        });
      });

      socket.on('sorted_rooms', function (data) {
        data.room_group_list.forEach(function(room_group) {
          room_group.slice(1).forEach(function(room_id) {
            document.getElementById(room_group[0]).nextElementSibling.appendChild(document.getElementById(room_id));
          });
        });
      });

      socket.on('edited_message', function(data) {
        message = document.getElementById(data.message_id);
        if (data.combine == 'false') {
          message.firstChild.nextElementSibling.nextElementSibling.innerHTML = '<span>' + parseMarkdown(escapeHTML(data.edit))  + '</span><span class="edited-note"> (edited)</span>';
        }
        else {
          document.getElementById(data.message_id).firstChild.nextElementSibling.innerHTML = '<span>' + parseMarkdown(escapeHTML(data.edit)) + '</span><span class="edited-note"> (edited)</span>';
        }
        message.setAttribute('data-markdown', data.edit);
      });

      socket.on('receive_message', function (data) {
        const newNode = document.createElement('div');
        newNode.setAttribute('data-markdown', data.message);
        newNode.setAttribute('data-datetime', data.datetime);
        newNode.setAttribute('data-user', data.user_id);
        chat_history_skip += 1;
        let messageMoment = moment(data.datetime).local().format('h:mm A');
        if (data.combine == 'false') {
          newNode.className = 'message-container';
          messageMoment = 'at ' + messageMoment;
          // TODO: Give pfp image default fallback image
          if (space_admin || admin || data.user_id == user_id) {
            newNode.innerHTML = '<img class="profile-picture pointer" alt="!"><p class="message-title"><span class="name pointer"></span><span class="datetime"> ' + messageMoment + '</span></p><p class="message"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"><img class="edit-message black-icon pointer" src="/static/images/edit.svg"><img class="delete-message red-icon pointer" src="/static/images/delete.svg"></div>';
          }
          else {
            newNode.innerHTML = '<img class="profile-picture pointer" alt="!"><p class="message-title"><span class="name pointer"></span><span class="datetime"> ' + messageMoment + '</span></p><p class="message"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"></div>';
          }
          newNode.firstElementChild.src = data.picture;
          newNode.firstElementChild.nextElementSibling.firstElementChild.textContent = data.name;
          newNode.firstElementChild.nextElementSibling.firstElementChild.style.fontWeight = 'bold';
          newNode.firstElementChild.nextElementSibling.nextElementSibling.innerHTML = '<span>' + parseMarkdown(escapeHTML(data.message)) + '</span>';
        }
        else {
          newNode.className = 'message-container-combine';
          if (space_admin || admin || data.user_id == user_id){
            newNode.innerHTML = '<p class="message-combine-time"> ' + messageMoment + '</p><p class="message-combine"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"><img class="edit-message pointer" src="/static/images/edit.svg"><img class="delete-message red-icon pointer" src="/static/images/delete.svg"></div>';
          }
          else{
            newNode.innerHTML = '<p class="message-combine-time"> ' + messageMoment + '</p><p class="message-combine"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"></div>';
          }
          newNode.firstElementChild.nextElementSibling.innerHTML = '</span>' + parseMarkdown(escapeHTML(data.message)) + '</span>';
        }
        newNode.id = data.message_id;
        $(document.querySelector('.temporary-message')).remove();
        document.getElementById('messages').append(newNode);
      });
      
      socket.on('is_typing', function (data) {
        if (!typing_list.includes(data.name) && data.name != user_name) {
          typing_list.push(data.name);
        }
        changeTypingDisplay();
      });
      
      socket.on('stopped_typing', function (data) {
        if (typing_list.includes(data.name)) {
          const index = typing_list.indexOf(data.name);
          if (index > -1) {
            typing_list.splice(index, 1);
          }
          changeTypingDisplay();
        }
      });
      
      socket.on('deleted_room', function(data) {
        $(document.getElementById(data.room)).remove();
        if (data.room == current_room) {
          joinRoom($('#regular-channels').find('.room')[0].id);
        }
      });
      
      socket.on('created_room', function(data) {
        const newNode = document.createElement('li');
        newNode.id = data.room_id;
        newNode.className = 'room pointer';
        newNode.setAttribute('data-section', data.section_id);
        newNode.setAttribute('data-name', data.name);
        newNode.textContent = data.name;
        const nodeList = document.querySelectorAll('li[data-section="' + data.section_id + '"]');
        if (nodeList.length != 0) {
          nodeList[nodeList.length - 1].parentNode.insertBefore(newNode, nodeList[nodeList.length - 1].nextElementSibling);
        }
        else {
          document.getElementById(data.section_id).nextElementSibling.appendChild(newNode);
        }
      });
      
      socket.on('created_section', function(data) {
        let newNode = document.createElement('ul');
        newNode.className = 'section-group';
        let newNodeChild = document.createElement('li');
        newNodeChild.className = 'section pointer';
        newNodeChild.id = data.section_id;
        newNodeChild.innerHTML = '<div class="section-name"><span><img class="collapse-icon" src="/static/images/expand.png"></img></span></div><div class="create-room-button" type="button">+</div>';
        newNodeChild.firstElementChild.appendChild(document.createTextNode(data.name))
        newNode.appendChild(newNodeChild);
        newNodeChild = document.createElement('ul');
        newNodeChild.className = 'room-group';
        newNode.appendChild(newNodeChild);
        document.getElementById('regular-channels').append(newNode);
        if (space_admin || admin) {
          $('.room-group').sortable({
            connectWith: '.room-group',
            axis: 'y',
            items: '.room',
            opacity: 0.7,
            scroll: false,
            distance: '3',
            update: function() {
              roomSort();
            }
          });
        }
      });

      socket.on('deleted_section', function(data) {
        let deleted_section = document.getElementById(data.section_id);
        const first_section = document.querySelector('.section:not([id="' + data.section_id + '"])');//:not([id*="' + data.section_id + '"])');
        let rooms = deleted_section.nextElementSibling.children
        const room_length = rooms.length;
        for (let i = 0; i < room_length; i++) {
          first_section.nextElementSibling.appendChild(rooms[0]);
        }
        deleted_section.parentElement.remove();
      });

      socket.on('deleted_space', function(data) {
        document.getElementById(current_space).parentNode.remove();
        $('.active-space').attr('style', '');
        $('#home-page').css('display', 'block');
        $('#administrator-page').css('display', 'none');
        $('#first-all').css('display', 'none');
        $('#space-search').css('display', 'none');
        $('#space-settings').css('display', 'none');
        $('user-page').css('display', 'none');
        $('.modal').hide();
        document.querySelector('.form-space[data-id="' + current_space + '"]').remove();
        current_space = '';
        current_room = '';
      });

      socket.on('deleted_message', function (data) {
        try {
          let class_name = document.getElementById(data['message_id']).className;
          if ($('#' + data['message_id']).next().length != 0) {
            if (class_name == "message-container" && document.getElementById(data['message_id']).nextElementSibling.className == "message-container-combine") {
              let new_message_text = document.getElementById(data['message_id']).nextElementSibling.firstChild.nextElementSibling.textContent;
              document.getElementById(data['message_id']).firstChild.nextElementSibling.nextElementSibling.textContent = new_message_text;
              if (document.getElementById(data['message_id']).firstChild.nextElementSibling.nextElementSibling.textContent.includes('Yesterday')) {
                let new_message_time = document.getElementById(data['message_id']).nextElementSibling.firstChild.textContent; 
                document.getElementById(data['message_id']).firstChild.nextElementSibling.firstChild.nextElementSibling.textContent = 'Yesterday at ' + new_message_time;
              } else if (document.getElementById(data['message_id']).firstChild.nextElementSibling.textContent.includes('/')){
                let new_message_date = document.getElementById(data['message_id']).nextElementSibling.getAttribute("data-date");
                document.getElementById(data['message_id']).firstChild.nextElementSibling.firstChild.nextElementSibling.textContent = new_message_date;
              }
              else {
                let new_message_time = document.getElementById(data['message_id']).nextElementSibling.firstChild.textContent; 
                document.getElementById(data['message_id']).firstChild.nextElementSibling.firstChild.nextElementSibling.textContent = 'at ' + new_message_time;
              }
              let message_id = document.getElementById(data['message_id']).nextElementSibling.id;
              document.getElementById(data['message_id']).nextElementSibling.remove();
              document.getElementById(data['message_id']).id = message_id;
            } else {
              document.getElementById(data['message_id']).remove();
            }
          }
          else {
            document.getElementById(data['message_id']).remove();
          }
        } catch(e) {
          alert(e);
        }
      });

      socket.on('sent_email', function (data) {
        chat_history_skip = 0;
        document.getElementById('messages').textContent = '';
        loadEmailHistory();
      });

      socket.on('joined_space', function (data) {
        if (!document.querySelector('.member[data-id="' + data['_id'] + '"]')) {
          let newNode = document.createElement('div');
          newNode.className = 'member pointer';
          newNode.setAttribute('data-id', data['_id']);
          newNode.innerHTML = '<img class="profile-picture" alt="!"><span class="member-name">' + data['name'] + '</span>';
          newNode.firstElementChild.src = data['picture'];
          newNode.firstElementChild.nextElementSibling.textContent = data['name'];
          document.getElementById('members').append(newNode);
          newNode = document.createElement('div');
          newNode.className = 'suggested_email suggested_email_individual pointer';
          newNode.setAttribute('data-email', data['email']);
          newNode.innerHTML = '<img class="profile-picture">';
          newNode.firstElementChild.src = data['picture'];
          newNode.appendChild(document.createTextNode(data['name'] + ' (' + data['email'] + ')'))
          document.getElementById('suggested_emails').append(newNode);
          if (!document.querySelector('.space-members-list-item[data-id="' + data['_id'] + '"]')) {
            newNode = document.createElement('div');
            newNode.className = 'space-members-list-item';
            newNode.setAttribute('data-id', data['_id']);
            newNode.innerHTML = '<span class="space-members-list-item-wrapper"><img class="profile-picture"><span class="member-information"></span></span><span class="user-role"><form class="change-user-status-form"><select class="user-status-select"><option value="banned">banned</option><option selected="selected" value="member">member</option><option value="moderator">moderator</option></select></form></span>';
            newNode.firstElementChild.firstElementChild.src = data['picture'];
            newNode.querySelector('.member-information').textContent = data['name'] + ' (' + data['email'] + ')';
            document.getElementById('space-members-list').appendChild(newNode);
          }
        }
      });

      socket.on('expired', function (data) {
        window.location.reload();
      });

      function space() {
        $.ajax({
          type: "POST",
          url: '/space',
          dataType: "json",
          data: JSON.stringify({'space_id': current_space}),
          contentType: 'application/json;charset=UTF-8',
          success: function(rooms_and_sections) {
            window.history.pushState('', '', '/school/' + current_space);
            applyTheme(rooms_and_sections[3][0].theme);
            if (rooms_and_sections[3][0].admins[0] == user_id) {
              space_admin = true;
              $('#delete-space').show();
              $('#leave-space').hide();
              $('#create-section-button').show();
              $('#edit-space-button').show();
              $('#invite-link-button').show();
              $("#email_input_form :input").prop("disabled", false);
            }
            else if (admin) {
              $('#delete-space').show();
              $('#leave-space').show();
              $('#create-section-sbutton').show();
              $('#edit-space-button').show();
              $('#invite-link-button').show();
              $("#email_input_form :input").prop("disabled", false);
            }
            else if (rooms_and_sections[3][0].admins.includes(user_id)) {
              space_admin = true;
              $('#delete-space').hide();
              $('#leave-space').show();
              $('#create-section-button').show();
              $('#edit-space-button').show();
              $('#invite-link-button').show();
              $("#email_input_form :input").prop("disabled", false);
            }
            else {
              space_admin = false;
              $('#delete-space').hide();
              $('#leave-space').show();
              $('#create-section-button').hide();
              $('#edit-space-button').hide();
              if (rooms_and_sections[3][0].invite_only) {
                $('#invite-link-button').hide();
              }
              else {
                $('#invite-link-button').show();
              }
              $("#email_input_form :input").prop("disabled", true);
            }
            document.getElementById('messages').textContent = '';
            document.getElementById('space-invites-list').textContent = '';
            document.getElementById('space-members-list').textContent = '';
            document.getElementById('header_text').textContent = rooms_and_sections[3][0].name;
            document.getElementById('edit-space-name-input').value = rooms_and_sections[3][0].name;
            document.getElementById('edit-space-name-input').setAttribute('data-pre', rooms_and_sections[3][0].name);
            document.getElementById('edit-space-picture-input').value = rooms_and_sections[3][0].picture;
            document.getElementById('edit-space-picture-input').setAttribute('data-pre', rooms_and_sections[3][0].picture);
            document.getElementById('edit-space-description-input').value = rooms_and_sections[3][0].description;
            document.getElementById('edit-space-description-input').setAttribute('data-pre', rooms_and_sections[3][0].description);
            $('#edit-space-invite-switch').prop('checked', rooms_and_sections[3][0].invite_only);
            document.getElementById('special-channels').textContent = '';
            document.getElementById('regular-channels').textContent = '';
            $('.suggested_email_individual').remove();
            document.getElementById('members').textContent = '';
            rooms_and_sections[1].forEach(function(section) {
              newNode = document.createElement('ul');
              newNode.className = 'section-group';
              let newNodeChild = document.createElement('li');
              newNodeChild.className = 'section pointer';
              newNodeChild.id = section['_id']['$oid'];
              if (space_admin || admin) {
                newNodeChild.innerHTML = '<div class="section-name"><span><img class="collapse-icon" src="/static/images/expand.png"></img></span></div><div class="create-room-button" type="button">+</div>';
              }
              else {
                newNodeChild.innerHTML = '<div class="section-name"><span><img class="collapse-icon" src="/static/images/expand.png"></img></span></div>';
              }
              newNodeChild.firstElementChild.appendChild(document.createTextNode(section['name']));
              newNode.append(newNodeChild);
              let newNodeChildContainer = document.createElement('ul');
              newNodeChildContainer.className = 'room-group';
              rooms_and_sections[0].forEach(function(room) {  //remove already used rooms from room_and_sections[0] to improve efficiency?
                if (room['section'] == section['_id']['$oid']) {
                  newNodeChild = document.createElement('li');
                  newNodeChild.className = 'room pointer';
                  newNodeChild.id = room['_id']['$oid'];
                  newNodeChild.setAttribute('data-section', room['section']);
                  newNodeChild.setAttribute('data-name', room['name']);
                  newNodeChild.textContent = room['name'];
                  newNodeChildContainer.append(newNodeChild);
                }
                newNode.append(newNodeChildContainer);
                document.getElementById('regular-channels').append(newNode);
              });
            });
            rooms_and_sections[0].forEach(function(room) {
              if (room['section'] == 'special') {
                let newNode = document.createElement('li');
                newNode.className = 'email special-room pointer';
                newNode.textContent = 'Email';
                newNode.setAttribute('data-name', room['name'])
                newNode.id = room['_id']['$oid'];
                document.getElementById('special-channels').append(newNode);
              }
            });
            if (space_admin || admin) {
              $('.room-group').sortable({
                connectWith: '.room-group',
                axis: 'y',
                items: '.room',
                opacity: 0.7,
                scroll: false,
                distance: '3',
                update: function() {
                  roomSort();
                }
              });
              $('#regular-channels').sortable('enable');
              const newFragmentInvites = document.createDocumentFragment();
              rooms_and_sections[4].forEach(function(invite) {
                newNode = document.createElement('div');
                newNode.id = invite['_id'];
                newNode.className = 'space-invites-list-item';
                newNode.innerHTML = '<span class="invite-information-wrapper"><img class="profile-picture"><span class="invite-information"></span></span><span class="invite-code"></span><span class="revoke-link"><img class="pointer white-icon revoke-invite-button" src="/static/images/x.svg"><span>';
                newNode.querySelector('.profile-picture').src = invite['picture'];
                newNode.querySelector('.invite-information').textContent = invite['name'] + ' (' + invite['email'] + ')';
                newNode.querySelector('.invite-code').textContent = invite['_id'];
                newFragmentInvites.appendChild(newNode);
              });
              document.getElementById('space-invites-list').append(newFragmentInvites);
            }
            else {
              $('#regular-channels').sortable('disable');
            }            
            const newFragmentMembers = document.createDocumentFragment();
            const newFragmentMembersOwner = document.createDocumentFragment();
            const newFragmentMembersModerators = document.createDocumentFragment();
            const newFragmentSettingsMembers = document.createDocumentFragment();
            const newFragmentEmails = document.createDocumentFragment();
            rooms_and_sections[2].forEach(function(member) {
              if (!rooms_and_sections[3][0].banned.includes(member['_id'])) {
                newNode = document.createElement('div');
                newNode.className = 'member pointer';
                newNode.setAttribute('data-id', member['_id']);
                if (rooms_and_sections[3][0].admins[0] == member['_id']) {
                  newNode.innerHTML = '<img class="profile-picture" alt="!"><span class="member-name"></span><img class="status-icon white-icon" src="/static/images/owner.svg">';
                  newNode.firstElementChild.src = member['picture'];
                  newNode.firstElementChild.nextElementSibling.textContent = member['name'];
                  newFragmentMembersOwner.appendChild(newNode);
                }
                else if (rooms_and_sections[3][0].admins.includes(member['_id'])) {
                  newNode.innerHTML = '<img class="profile-picture" alt="!"><span class="member-name"></span><img class="status-icon white-icon" src="/static/images/moderator.svg">';
                  newNode.firstElementChild.src = member['picture'];
                  newNode.firstElementChild.nextElementSibling.textContent = member['name'];
                  newFragmentMembersModerators.appendChild(newNode);
                }
                else {
                  newNode.innerHTML = '<img class="profile-picture" alt="!"><span class="member-name"></span>';
                  newNode.firstElementChild.src = member['picture'];
                  newNode.firstElementChild.nextElementSibling.textContent = member['name'];
                  newFragmentMembers.appendChild(newNode);
                }
                newNode = document.createElement('div');
                newNode.className = 'suggested_email suggested_email_individual pointer';
                newNode.setAttribute('data-email', member['email']);
                newNode.innerHTML = '<img class="profile-picture">'
                newNode.firstElementChild.src = member['picture'];
                newNode.appendChild(document.createTextNode(member['name'] + ' (' + member['email'] + ')'));
                newFragmentEmails.appendChild(newNode);
              }
              newNode = document.createElement('div');
              newNode.className = 'space-members-list-item';
              newNode.setAttribute('data-id', member['_id']);
              if (rooms_and_sections[3][0].admins[0] == member['_id']) {
                newNode.innerHTML = '<span class="space-members-list-item-wrapper"><img class="profile-picture"><span class="member-information"></span></span><span class="user-role"><select class="user-status-select" disabled><option>owner</option></select></span>';
              }
              else if (rooms_and_sections[3][0].admins.includes(member['_id'])) {
                newNode.innerHTML = '<span class="space-members-list-item-wrapper"><img class="profile-picture"><span class="member-information"></span></span><span class="user-role"><form class="change-user-status-form"><select class="user-status-select"><option value="banned">banned</option><option value="member">member</option><option selected="selected" value="moderator">moderator</option></select></form></span>';
              }
              else if (rooms_and_sections[3][0].banned.includes(member['_id'])) {
                newNode.innerHTML = '<span class="space-members-list-item-wrapper"><img class="profile-picture"><span class="member-information"></span></span><span class="user-role"><form class="change-user-status-form"><select class="user-status-select"><option selected="selected" value="banned">banned</option><option value="member">member</option><option value="moderator">moderator</option></select></form></span>';
              }
              else {
                newNode.innerHTML = '<span class="space-members-list-item-wrapper"><img class="profile-picture"><span class="member-information"></span></span><span class="user-role"><form class="change-user-status-form"><select class="user-status-select"><option value="banned">banned</option><option selected="selected" value="member">member</option><option value="moderator">moderator</option></select></form></span>';
              }
              newNode.querySelector('.profile-picture').src = member['picture'];
              newNode.querySelector('.member-information').textContent = member['name'] + ' (' + member['email'] + ')';
              newFragmentSettingsMembers.appendChild(newNode);
            });
            document.getElementById('members').append(newFragmentMembersOwner);
            document.getElementById('members').append(newFragmentMembersModerators);
            document.getElementById('members').append(newFragmentMembers);
            document.getElementById('suggested_emails').append(newFragmentEmails);
            document.getElementById('space-members-list').append(newFragmentSettingsMembers);
            if (add_to_members) {
              socket.emit('joined_space');
              add_to_members = false;
            }
            joinRoom(document.querySelector('.room').id);
            $('#home-page').css('display', 'none');
            $('#administrator-page').css('display', 'none');
            $('#first-all').css('display', 'block');
            $('#user-page').css('display', 'none');
            $('#space-settings').css('display', 'none');
            $('#space-search').css('display', 'none');
            $('#space-search').css('pointer-events', 'initial');
          }
        });
      }

      function joinSpace(space_id) { //Use Socket.io to add to members
        $.ajax({
          type: "POST",
          url: '/join_space',
          dataType: "json",
          data: JSON.stringify({'space_id': space_id}),
          contentType: 'application/json;charset=UTF-8',
          success: function(data) {
            if ('invalid_invite' in data) {
              alert('Your invite is invalid');
              $("#space-search").css('pointer-events', 'initial');
            }
            else if ('only_invite' in data) {
              alert('This space is invite only');
              $("#space-search").css('pointer-events', 'initial');
            }
            else if ('exists' in data) {
              alert('This space does not exist');
              $("#space-search").css('pointer-events', 'initial');
            }
            else if ('ban' in data) {
              alert('You are banned from this space');
              $("#space-search").css('pointer-events', 'initial');
            }
            else {
              $(document.getElementById(current_space)).closest('.space-wrapper').find('.active-space').attr('style', '');
              $(document.getElementById(current_space)).attr('style', '');
              $('#profile-popup').remove();
              selected_user = '';
              $("#space-search").animate({opacity: '0'}, 100);
              current_room = '';
              current_space = space_id;
              if(!data['members'].some(row => row.includes(user_id))) {
                const formSpace = document.querySelector('.form-space[data-id="' + current_space + '"]').querySelector('.directory-space-joined-status')
                formSpace.textContent = "Joined";
                formSpace.className = 'directory-space-joined-status joined-status';
                let newNode = document.createElement('li');
                newNode.className = 'space-wrapper';
                let newNodeChild = document.createElement('img');
                newNodeChild.className = 'space pointer';
                newNodeChild.id = data['_id']['$oid'];
                newNodeChild.style.borderRadius = '3px';
                newNodeChild.setAttribute('data-name', data['name']);
                newNodeChild.src = data['picture'];
                newNode.appendChild(newNodeChild);
                newNodeChild = document.createElement('div');
                newNodeChild.className = 'active-space';
                newNodeChild.style.width = '39px';
                newNode.appendChild(newNodeChild);
                referenceNode = document.getElementById('space_align_helper');
                referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
                add_to_members = true;
              }
              else {
                $('#' + current_space).css('border-radius', '3px');
                $('#' + current_space).closest('.space-wrapper').find('.active-space').css('width', '39px');
              }
              space();
            }
          }
        });
      }

      function joinRoom(room_id, special = false) {
        if (current_room != room_id) {
          const old_room = current_room;
          $(document.getElementById(old_room)).attr('style', '');
          if (old_room != "" && document.getElementById(old_room) && document.getElementById(old_room).parentElement.previousElementSibling?.classList.contains("collapsed")) {
            document.getElementById(old_room).style.display = "none";
          }
          current_room = room_id;
          socket.emit('join_room', {
            room_id: current_room,
            old_room: old_room
          });
          $(document.getElementById(current_room)).attr('style', 'background-color: var(--selected-color) !important');
          document.getElementById('messages').textContent = '';
          document.getElementById('room-name-display').textContent = document.getElementById(current_room).getAttribute('data-name');
          document.getElementById('members_header').textContent = document.getElementById(current_room).getAttribute('data-name');
          if (special) {
            $('#message_input_form').hide();
            $('#email_input_form').show();
            chat_history_skip = 0;
            loadEmailHistory();
          }
          else {
            $('#message_input_form').show();
            $('#email_input_form').hide();
            chat_history_skip = 0;
            loadChatHistory();
          }
          typing_display.textContent = '';
          typing_list = [];
          stoppedTyping();
        }
      }

      function loadChatHistory() {
        abortRequests();
        requests.push($.ajax({
          type: 'POST',
          url: '/chat_history',
          dataType: "json",
          data: JSON.stringify({'i': String(chat_history_skip), 'room_id': current_room}),
          contentType: 'application/json;charset=UTF-8',
          success: function(chat_history) {
            if (chat_history_skip == 0) {
              document.getElementById('messages').textContent = '';
            }
            chat_history_skip += 50;
            let todayDate = moment();
            let yesterdayDate = moment().subtract(1, 'day');
            chat_history.forEach(function(item) {
              let messageDate = moment(item.datetime);
              const newNode = document.createElement('div');
              newNode.setAttribute('data-markdown', item.message);
              newNode.setAttribute('data-datetime', item.datetime);
              newNode.setAttribute('data-user', item.user_id);
              if (item.combine == 'false') {
                newNode.className = 'message-container';
                newNode.setAttribute('data-date', messageDate.format('M/D/YYYY'));
                if(moment(messageDate).isSame(todayDate, 'day')) {
                  messageDate = 'at ' + messageDate.format('h:mm A');
                }
                else if(moment(messageDate).isSame(yesterdayDate, 'day')) {
                  messageDate = 'Yesterday at ' + messageDate.format('h:mm A');
                }
                else {
                    messageDate = 'on ' + messageDate.format('M/D/YYYY');
                }
                if (space_admin || admin || item.user_id == user_id) {
                  newNode.innerHTML = '<img class="profile-picture pointer" alt="!"><p class="message-title"><span class="name pointer"></span><span class="datetime"> ' + messageDate + '</span></p><p class="message"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"><img class="edit-message black-icon pointer" src="/static/images/edit.svg"><img class="delete-message red-icon pointer" src="/static/images/delete.svg"></div>';
                }
                else {
                  newNode.innerHTML = '<img class="profile-picture pointer" alt="!"><p class="message-title"><span class="name pointer"></span><span class="datetime"> ' + messageDate + '</span></p><p class="message"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"></div>';
                }
                newNode.firstElementChild.src = item.picture;
                newNode.firstElementChild.nextElementSibling.firstElementChild.textContent = item.name;
                newNode.firstElementChild.nextElementSibling.firstElementChild.style.fontWeight = 'bold';
                if (item.edited == true) {
                  newNode.firstElementChild.nextElementSibling.nextElementSibling.innerHTML = '</span>' + parseMarkdown(escapeHTML(item.message)) + '</span><span class="edited-note"> (edited)</span>';
                }
                else {
                  newNode.firstElementChild.nextElementSibling.nextElementSibling.innerHTML = '<span>' + parseMarkdown(escapeHTML(item.message)) + '</span>';
                }
              }
              else {
                newNode.className = 'message-container-combine';
                newNode.setAttribute('data-date', messageDate.format('M/D/YYYY'));
                if (space_admin || admin || item.user_id == user_id) {
                  newNode.innerHTML = '<p class="message-combine-time">' + messageDate.format('h:mm A') + '</p><p class="message-combine"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"><img class="edit-message black-icon pointer" src="/static/images/edit.svg"><img class="delete-message red-icon pointer" src="/static/images/delete.svg"></div>'; 
                } 
                else {
                  newNode.innerHTML = '<p class="message-combine-time">' + messageDate.format('h:mm A') + '</p><p class="message-combine"></p><div class="message-options"><img class="report-message black-icon pointer" src="/static/images/report.svg"></div>';
                }
                if (item.edited == true) {
                  newNode.firstElementChild.nextElementSibling.innerHTML = '<span>' +  parseMarkdown(escapeHTML(item.message)) + '</span><span class="edited-note"> (edited)</span>';
                }
                else {
                  newNode.firstElementChild.nextElementSibling.innerHTML = '<span>' +  parseMarkdown(escapeHTML(item.message)) + '</span>';
                }
              }
              newNode.id = item._id.$oid;
              document.getElementById('messages').prepend(newNode);
            });
          } 
        }));
      }

      function loadEmailHistory() {
        abortRequests();
        requests.push($.ajax({
          type: 'POST',
          url: '/email_history',
          dataType: "json",
          data: JSON.stringify({'i': String(chat_history_skip), 'room_id': current_room}),
          contentType: 'application/json;charset=UTF-8',
          success: function(email_history) {
            chat_history_skip += 50;
            let todayDate = moment();
            let yesterdayDate = moment().subtract(1, 'day');
            email_history.forEach(function(item) {
              let emailDate = moment(item.datetime);
              const newNode = document.createElement('div');
              newNode.className = 'message-container';
              newNode.id = item._id.$oid;
              newNode.setAttribute('data-date', emailDate.format('M/D/YYYY'));
              if(moment(emailDate).isSame(todayDate, 'day')) {
                emailDate = 'at ' + emailDate.format('h:mm A');
              }
              else if(moment(emailDate).isSame(yesterdayDate, 'day')) {
                emailDate = 'Yesterday at ' + emailDate.format('h:mm A');
              }
              else {
                emailDate = 'on ' + emailDate.format('M/D/YYYY');
              }
              newNode.innerHTML = '<img class="profile-picture pointer" alt="!"><p class="message-title"><span class="name pointer"></span><span class="datetime"> ' + emailDate + '</span></p><div class="email-container-container"><div class="recipient-list"></div><img class="expand-recipient-list pointer" data-expanded="false" src="/static/images/expand.png"><div class="email-container"><p class="email-subject"></p><p class="email-message"></p></div></div>';
              newNode.firstElementChild.src = item.picture;
              newNode.firstElementChild.nextElementSibling.firstElementChild.textContent = item.name;
              newNode.firstElementChild.nextElementSibling.firstElementChild.style.fontWeight = 'bold';
              newNode.querySelector('.recipient-list').textContent = 'to ' + item.recipients.join(', ');
              newNode.querySelector('.email-subject').textContent = item.subject;
              newNode.querySelector('.email-message').textContent = item.message;
              document.getElementById('messages').prepend(newNode);
            });
          }
        }));
      }

      function roomSort() {
        let room_group = document.querySelectorAll('.room-group');
        let room_group_list = [];
        for (let i = 0; i < room_group.length; i++) {
          let rooms = room_group[i].querySelectorAll('.room');
          let room_list = [room_group[i].previousElementSibling.id];
          for (let j = 0; j < rooms.length; j++) {
            room_list.push(rooms[j].id);
          }
          room_group_list.push(room_list);
        }
        socket.emit('sorted_rooms', {
          room_group_list: room_group_list
        });
      }

      // Scrolling vertically on the spaces div
      // Only for non-mobile devices.
      // Contextmenu 
      const scrollContainer = document.getElementById('spaces'); 
      scrollContainer.addEventListener("wheel", (evt) => {
        evt.preventDefault();
        scrollContainer.scrollLeft += evt.deltaY;
      });

      function mouseX(evt) {
        if (evt.pageX) {
          return evt.pageX;
        } else if (evt.clientX) {
          return evt.clientX + (document.documentElement.scrollLeft ?
            document.documentElement.scrollLeft :
            document.body.scrollLeft);
        } else {
          return null;
        }
      }

      function mouseY(evt) {
        if (evt.pageY) {
          return evt.pageY;
        } else if (evt.clientY) {
          return evt.clientY + (document.documentElement.scrollTop ?
            document.documentElement.scrollTop :
            document.body.scrollTop);
        } else {
          return null;
        }
      }

      let typing_display = document.getElementById('typing_display');
      function changeTypingDisplay() {
        if (typing_list.length == 0) {
          typing_display.textContent = '';
        }
        else if (typing_list.length == 1) {
          typing_display.innerHTML = '<b></b> is typing...';
          typing_display.firstElementChild.textContent = typing_list[0];
        }
        else if (typing_list.length == 2) {
          typing_display.innerHTML = '<b></b> and <b></b> are typing...';
          typing_display.firstElementChild.textContent = typing_list[0];
          typing_display.firstElementChild.nextElementChild.textContent = typing_list[1];
        }
        else if (typing_list.length == 3) {
          typing_display.innerHTML = '<b></b>, <b></b>, and <b></b> are typing...';
          typing_display.firstElementChild.textContent = typing_list[0];
          typing_display.firstElementChild.nextElementChild.textContent = typing_list[1];
          typing_display.firstElementChild.nextElementChild.nextElementChild.textContent = typing_list[2];
        }
        else {
          typing_display.innerHTML = '<b></b>, <b></b>, <b></b>, and' + String(typing_list.length - 3) + ' others are typing...';
          typing_display.firstElementChild.textContent = typing_list[0];
          typing_display.firstElementChild.nextElementChild.textContent = typing_list[1];
          typing_display.firstElementChild.nextElementChild.nextElementChild.textContent = typing_list[2];
        }
      }

      function stoppedTyping() {
        typing = false;
        socket.emit('stopped_typing', {
          name: user_name,
          room_id: current_room
        });
      }

      function isTyping() {
        if (typing == false) {
          typing = true;
          socket.emit('is_typing', {
            name: user_name,
            room_id: current_room
          });
          timeout = setTimeout(stoppedTyping, 5000);
        }
        else {
          clearTimeout(timeout);
          timeout = setTimeout(stoppedTyping, 5000);
        }
      }

      function emailAccepted(email) {
        let newNode = document.createElement('div');
        newNode.className = 'accepted_email_bubble';
        let newNodeChild = document.createElement('span');
        newNodeChild.className = 'accepted_email';
        newNodeChild.textContent = email;
        newNode.appendChild(newNodeChild);
        newNodeChild = document.createElement('img');
        newNodeChild.className = 'delete-email-icon pointer'
        newNodeChild.src = '/static/images/x.svg';
        newNode.appendChild(newNodeChild);
        document.getElementById('email_to_list').insertBefore(newNode, document.getElementById('email_to_input_span'));
      }

      function abortRequests() {
        requests.forEach(function (request) {
          request.abort();
        });
      }
      function swipeStart(e) {
        touchstartX = e.changedTouches[0].screenX;
        touchstartY = e.changedTouches[0].screenY;
      }
      function swipeEnd(e) {
        touchendX = e.changedTouches[0].screenX;
        touchendY = e.changedTouches[0].screenY;
        checkDirection();
      }

      function popupSuccess() {
        successPopup = document.getElementById('success-icon');
        successPopup.src = '';
        successPopup.src = '/static/images/success.gif';
        $(successPopup).css('display', 'inline-block');
        setTimeout(function() {
          $(successPopup).animate({opacity: '0'}, 300, function() {
            $(successPopup).removeAttr("style");
          });
        }, 500);
      }

      function hideSecondLayer() {
        let container = $("#space-settings-popup");
        let profile_popup = $("#profile-popup");
        let section_menu = $('#section-menu');
        let room_menu = $('#room-menu');
        container.hide();
        profile_popup.hide();
        section_menu.hide();
        room_menu.hide();
      }

      function escapeHTML(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function parseMarkdown(markdownText) {
	      return markdownText
		      .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
		      .replace(/\*(.*)\*/gim, '<i>$1</i>');
      }

      function toMarkdown(markdownHTML) {
        return markdownHTML
          .replace('<b>', '**')
          .replace('</b>', '**')
          .replace('<i>', '*')
          .replace('</i>', '*');
      }

      async function checkImage(url){
        const res = await fetch(url);
        const buff = await res.blob();
        return buff.type.startsWith('image/')
      }

      $(document).ajaxError(function myErrorHandler(event, xhr, ajaxOptions, thrownError) {
        var contentType = xhr.getResponseHeader("Content-Type");
        if (xhr.status === 200 && contentType.toLowerCase().indexOf("text/html") >= 0) {
          window.location.reload();
        }
        if (xhr.status === 405 && contentType.toLowerCase().indexOf("text/html") >= 0) {
          window.location.reload();
        }
      });

      $(document).on('click', '.theme-container', function() {
        socket.emit('change_theme', {
          theme: this.id.slice(0, -6)
        });
      });

      socket.on('change_theme', function (data) {
        applyTheme(data['theme'])
      });

      function applyTheme(theme) {
        const root = document.querySelector(':root');
        root.style.setProperty('--main-bg-color', themes[theme][0]);
        root.style.setProperty('--main-font-color', themes[theme][1]);
        root.style.setProperty('--second-bg-color', themes[theme][2]);
        root.style.setProperty('--second-font-color', themes[theme][3]);
        root.style.setProperty('--third-bg-color', themes[theme][4]);
        root.style.setProperty('--footer-bg-color', themes[theme][5]);
        root.style.setProperty('--footer-border-color', themes[theme][6]);
        root.style.setProperty('--footer-font-color', themes[theme][7]);
        root.style.setProperty('--thumb-color', themes[theme][8]);
        root.style.setProperty('--track-color', themes[theme][9]);
        root.style.setProperty('--border-color', themes[theme][10]);
        root.style.setProperty('--textarea-bg-color', themes[theme][11]);
        root.style.setProperty('--textarea-font-color', themes[theme][12]);
        root.style.setProperty('--main-hover-color', themes[theme][13]);
        root.style.setProperty('--second-hover-color', themes[theme][14]);
        root.style.setProperty('--selected-color', themes[theme][15]);
        modifyCSS('.black-icon', 'filter', themes[theme][16]);
      }

      function modifyCSS(selector, property, value) {
        for (var i=0; i<document.styleSheets.length;i++) {
            try { document.styleSheets[i].insertRule(selector+ ' {'+property+':'+value+'}', document.styleSheets[i].cssRules.length);
            } catch(err) {try { document.styleSheets[i].addRule(selector, property+':'+value);} catch(err) {}}
        }
      }

    });

    //applyTheme function, Home Button, Click Space, Join Space admin change

    //Don't use innerHTML, replace later.

    //broadcast to everyone when a space is created.

    // REST, please

    //preload images

    // autoupdate settings

    //use id of space to get space name for admin tables

    // load more button admin tables

    //when ban from space, call leave space 

    //fix user status settings please

    // better queries for admin logs...

    // below psuedocode comments for saving unsent messages
      // list of messages being typed by user containing message (updated when user clicks on space or another room) and room id.
      // new NOTE: just use a hashmap man
      // ['2hu45iu2323', 'Hi I love apples and cakes they are cool', '34yubjub42', 'I love appels']
      // Loop through this and check if joined room id is equal to any of these. If so, get index of that ID add one and make the message that message. Yep okay easy peasy lemon SQUEEEEZY.
  </script>
</html>